---
title: 'Lo·∫°i b·ªè c√°c dependency kh√¥ng c·∫ßn thi·∫øt c·ªßa Effect'
---

<Intro>

Khi b·∫°n vi·∫øt m·ªôt Effect, linter s·∫Ω x√°c minh r·∫±ng b·∫°n ƒë√£ bao g·ªìm m·ªçi gi√° tr·ªã reactive (nh∆∞ props v√† state) m√† Effect ƒë·ªçc trong danh s√°ch c√°c dependency c·ªßa Effect ƒë√≥. ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o r·∫±ng Effect c·ªßa b·∫°n lu√¥n ƒë·ªìng b·ªô v·ªõi props v√† state m·ªõi nh·∫•t c·ªßa component. C√°c dependency kh√¥ng c·∫ßn thi·∫øt c√≥ th·ªÉ khi·∫øn Effect ch·∫°y qu√° th∆∞·ªùng xuy√™n, ho·∫∑c th·∫≠m ch√≠ t·∫°o ra m·ªôt v√≤ng l·∫∑p v√¥ h·∫°n. H√£y l√†m theo h∆∞·ªõng d·∫´n n√†y ƒë·ªÉ xem x√©t v√† lo·∫°i b·ªè c√°c dependency kh√¥ng c·∫ßn thi·∫øt kh·ªèi Effect c·ªßa b·∫°n.

</Intro>

<YouWillLearn>

- C√°ch s·ª≠a v√≤ng l·∫∑p dependency Effect v√¥ h·∫°n
- Ph·∫£i l√†m g√¨ khi b·∫°n mu·ªën lo·∫°i b·ªè m·ªôt dependency
- C√°ch ƒë·ªçc m·ªôt gi√° tr·ªã t·ª´ Effect m√† kh√¥ng "ph·∫£n ·ª©ng" v·ªõi n√≥
- C√°ch v√† t·∫°i sao n√™n tr√°nh c√°c dependency l√† object v√† function
- T·∫°i sao vi·ªác b·ªè qua dependency linter l√† nguy hi·ªÉm, v√† ph·∫£i l√†m g√¨ thay th·∫ø

</YouWillLearn>

## C√°c dependency n√™n kh·ªõp v·ªõi code {/*dependencies-should-match-the-code*/}

Khi b·∫°n vi·∫øt m·ªôt Effect, tr∆∞·ªõc ti√™n b·∫°n ch·ªâ ƒë·ªãnh c√°ch [b·∫Øt ƒë·∫ßu v√† d·ª´ng](/learn/lifecycle-of-reactive-effects#the-lifecycle-of-an-effect) nh·ªØng g√¨ b·∫°n mu·ªën Effect th·ª±c hi·ªán:

```js {5-7}
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => connection.disconnect();
  	// ...
}
```

Sau ƒë√≥, n·∫øu b·∫°n ƒë·ªÉ c√°c dependency c·ªßa Effect tr·ªëng (`[]`), linter s·∫Ω g·ª£i √Ω c√°c dependency ƒë√∫ng:

<Sandpack>

```js
import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => connection.disconnect();
  }, []); // <-- Fix the mistake here!
  return <h1>Welcome to the {roomId} room!</h1>;
}

export default function App() {
  const [roomId, setRoomId] = useState('general');
  return (
    <>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom roomId={roomId} />
    </>
  );
}
```

```js src/chat.js
export function createConnection(serverUrl, roomId) {
  // A real implementation would actually connect to the server
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
input { display: block; margin-bottom: 20px; }
button { margin-left: 10px; }
```

</Sandpack>

ƒêi·ªÅn ch√∫ng theo nh·ªØng g√¨ linter n√≥i:

```js {6}
function ChatRoom({ roomId }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // ‚úÖ All dependencies declared
  // ...
}
```

[Effect "ph·∫£n ·ª©ng" v·ªõi c√°c gi√° tr·ªã reactive.](/learn/lifecycle-of-reactive-effects#effects-react-to-reactive-values) V√¨ `roomId` l√† m·ªôt gi√° tr·ªã reactive (n√≥ c√≥ th·ªÉ thay ƒë·ªïi do m·ªôt l·∫ßn render l·∫°i), linter x√°c minh r·∫±ng b·∫°n ƒë√£ ch·ªâ ƒë·ªãnh n√≥ nh∆∞ m·ªôt dependency. N·∫øu `roomId` nh·∫≠n m·ªôt gi√° tr·ªã kh√°c, React s·∫Ω ƒë·ªìng b·ªô l·∫°i Effect c·ªßa b·∫°n. ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o r·∫±ng cu·ªôc tr√≤ chuy·ªán lu√¥n k·∫øt n·ªëi v·ªõi ph√≤ng ƒë∆∞·ª£c ch·ªçn v√† "ph·∫£n ·ª©ng" v·ªõi dropdown:

<Sandpack>

```js
import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]);
  return <h1>Welcome to the {roomId} room!</h1>;
}

export default function App() {
  const [roomId, setRoomId] = useState('general');
  return (
    <>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom roomId={roomId} />
    </>
  );
}
```

```js src/chat.js
export function createConnection(serverUrl, roomId) {
  // A real implementation would actually connect to the server
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
input { display: block; margin-bottom: 20px; }
button { margin-left: 10px; }
```

</Sandpack>

### ƒê·ªÉ lo·∫°i b·ªè m·ªôt dependency, h√£y ch·ª©ng minh r·∫±ng n√≥ kh√¥ng ph·∫£i l√† dependency {/*to-remove-a-dependency-prove-that-its-not-a-dependency*/}

L∆∞u √Ω r·∫±ng b·∫°n kh√¥ng th·ªÉ "ch·ªçn" c√°c dependency c·ªßa Effect. M·ªçi <CodeStep step={2}>gi√° tr·ªã reactive</CodeStep> ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi code Effect c·ªßa b·∫°n ƒë·ªÅu ph·∫£i ƒë∆∞·ª£c khai b√°o trong danh s√°ch dependency c·ªßa b·∫°n. Danh s√°ch dependency ƒë∆∞·ª£c x√°c ƒë·ªãnh b·ªüi code xung quanh:

```js [[2, 3, "roomId"], [2, 5, "roomId"], [2, 8, "roomId"]]
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) { // This is a reactive value
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId); // This Effect reads that reactive value
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // ‚úÖ So you must specify that reactive value as a dependency of your Effect
  // ...
}
```

[Gi√° tr·ªã reactive](/learn/lifecycle-of-reactive-effects#all-variables-declared-in-the-component-body-are-reactive) bao g·ªìm props v√† t·∫•t c·∫£ c√°c bi·∫øn v√† function ƒë∆∞·ª£c khai b√°o tr·ª±c ti·∫øp b√™n trong component c·ªßa b·∫°n. V√¨ `roomId` l√† m·ªôt gi√° tr·ªã reactive, b·∫°n kh√¥ng th·ªÉ lo·∫°i b·ªè n√≥ kh·ªèi danh s√°ch dependency. Linter s·∫Ω kh√¥ng cho ph√©p:

```js {8}
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => connection.disconnect();
  }, []); // üî¥ React Hook useEffect has a missing dependency: 'roomId'
  // ...
}
```

V√† linter s·∫Ω ƒë√∫ng! V√¨ `roomId` c√≥ th·ªÉ thay ƒë·ªïi theo th·ªùi gian, ƒëi·ªÅu n√†y s·∫Ω t·∫°o ra m·ªôt bug trong code c·ªßa b·∫°n.

**ƒê·ªÉ lo·∫°i b·ªè m·ªôt dependency, h√£y "ch·ª©ng minh" cho linter r·∫±ng n√≥ *kh√¥ng c·∫ßn* ph·∫£i l√† m·ªôt dependency.** V√≠ d·ª•, b·∫°n c√≥ th·ªÉ di chuy·ªÉn `roomId` ra kh·ªèi component ƒë·ªÉ ch·ª©ng minh r·∫±ng n√≥ kh√¥ng reactive v√† s·∫Ω kh√¥ng thay ƒë·ªïi khi render l·∫°i:

```js {2,9}
const serverUrl = 'https://localhost:1234';
const roomId = 'music'; // Not a reactive value anymore

function ChatRoom() {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => connection.disconnect();
  }, []); // ‚úÖ All dependencies declared
  // ...
}
```

B√¢y gi·ªù `roomId` kh√¥ng ph·∫£i l√† m·ªôt gi√° tr·ªã reactive (v√† kh√¥ng th·ªÉ thay ƒë·ªïi khi render l·∫°i), n√≥ kh√¥ng c·∫ßn ph·∫£i l√† m·ªôt dependency:

<Sandpack>

```js
import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

const serverUrl = 'https://localhost:1234';
const roomId = 'music';

export default function ChatRoom() {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => connection.disconnect();
  }, []);
  return <h1>Welcome to the {roomId} room!</h1>;
}
```

```js src/chat.js
export function createConnection(serverUrl, roomId) {
  // A real implementation would actually connect to the server
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
input { display: block; margin-bottom: 20px; }
button { margin-left: 10px; }
```

</Sandpack>

ƒê√¢y l√† l√Ω do t·∫°i sao b√¢y gi·ªù b·∫°n c√≥ th·ªÉ ch·ªâ ƒë·ªãnh [danh s√°ch dependency tr·ªëng (`[]`)](/learn/lifecycle-of-reactive-effects#what-an-effect-with-empty-dependencies-means). Effect c·ªßa b·∫°n *th·ª±c s·ª± kh√¥ng* ph·ª• thu·ªôc v√†o b·∫•t k·ª≥ gi√° tr·ªã reactive n√†o n·ªØa, v√¨ v·∫≠y n√≥ *th·ª±c s·ª± kh√¥ng* c·∫ßn ch·∫°y l·∫°i khi b·∫•t k·ª≥ props ho·∫∑c state n√†o c·ªßa component thay ƒë·ªïi.

### ƒê·ªÉ thay ƒë·ªïi c√°c dependency, h√£y thay ƒë·ªïi code {/*to-change-the-dependencies-change-the-code*/}

B·∫°n c√≥ th·ªÉ nh·∫≠n th·∫•y m·ªôt m√¥ h√¨nh trong quy tr√¨nh l√†m vi·ªác c·ªßa m√¨nh:

1. Tr∆∞·ªõc ti√™n, b·∫°n **thay ƒë·ªïi code** c·ªßa Effect ho·∫∑c c√°ch c√°c gi√° tr·ªã reactive ƒë∆∞·ª£c khai b√°o.
2. Sau ƒë√≥, b·∫°n l√†m theo linter v√† ƒëi·ªÅu ch·ªânh c√°c dependency ƒë·ªÉ **kh·ªõp v·ªõi code b·∫°n ƒë√£ thay ƒë·ªïi.**
3. N·∫øu b·∫°n kh√¥ng h√†i l√≤ng v·ªõi danh s√°ch dependency, b·∫°n **quay l·∫°i b∆∞·ªõc ƒë·∫ßu ti√™n** (v√† thay ƒë·ªïi code l·∫°i).

Ph·∫ßn cu·ªëi c√πng r·∫•t quan tr·ªçng. **N·∫øu b·∫°n mu·ªën thay ƒë·ªïi c√°c dependency, h√£y thay ƒë·ªïi code xung quanh tr∆∞·ªõc.** B·∫°n c√≥ th·ªÉ nghƒ© v·ªÅ danh s√°ch dependency nh∆∞ [m·ªôt danh s√°ch t·∫•t c·∫£ c√°c gi√° tr·ªã reactive ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi code Effect c·ªßa b·∫°n.](/learn/lifecycle-of-reactive-effects#react-verifies-that-you-specified-every-reactive-value-as-a-dependency) B·∫°n kh√¥ng *ch·ªçn* c√°i g√¨ ƒë·ªÉ ƒë∆∞a v√†o danh s√°ch ƒë√≥. Danh s√°ch *m√¥ t·∫£* code c·ªßa b·∫°n. ƒê·ªÉ thay ƒë·ªïi danh s√°ch dependency, h√£y thay ƒë·ªïi code.

ƒêi·ªÅu n√†y c√≥ th·ªÉ gi·ªëng nh∆∞ vi·ªác gi·∫£i m·ªôt ph∆∞∆°ng tr√¨nh. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu v·ªõi m·ªôt m·ª•c ti√™u (v√≠ d·ª•, ƒë·ªÉ lo·∫°i b·ªè m·ªôt dependency), v√† b·∫°n c·∫ßn "t√¨m" code ph√π h·ª£p v·ªõi m·ª•c ti√™u ƒë√≥. Kh√¥ng ph·∫£i ai c≈©ng th·∫•y vi·ªác gi·∫£i ph∆∞∆°ng tr√¨nh th√∫ v·ªã, v√† ƒëi·ªÅu t∆∞∆°ng t·ª± c√≥ th·ªÉ n√≥i v·ªÅ vi·ªác vi·∫øt Effect! May m·∫Øn thay, c√≥ m·ªôt danh s√°ch c√°c c√¥ng th·ª©c ph·ªï bi·∫øn m√† b·∫°n c√≥ th·ªÉ th·ª≠ b√™n d∆∞·ªõi.

<Pitfall>

N·∫øu b·∫°n c√≥ m·ªôt codebase hi·ªán c√≥, b·∫°n c√≥ th·ªÉ c√≥ m·ªôt s·ªë Effect b·ªè qua linter nh∆∞ th·∫ø n√†y:

```js {3-4}
useEffect(() => {
  // ...
  // üî¥ Avoid suppressing the linter like this:
  // eslint-ignore-next-line react-hooks/exhaustive-deps
}, []);
```

**Khi c√°c dependency kh√¥ng kh·ªõp v·ªõi code, c√≥ nguy c∆° r·∫•t cao s·∫Ω t·∫°o ra bug.** B·∫±ng c√°ch b·ªè qua linter, b·∫°n "n√≥i d·ªëi" React v·ªÅ c√°c gi√° tr·ªã m√† Effect c·ªßa b·∫°n ph·ª• thu·ªôc v√†o.

Thay v√†o ƒë√≥, h√£y s·ª≠ d·ª•ng c√°c k·ªπ thu·∫≠t b√™n d∆∞·ªõi.

</Pitfall>

<DeepDive>

#### T·∫°i sao vi·ªác b·ªè qua dependency linter l·∫°i nguy hi·ªÉm? {/*why-is-suppressing-the-dependency-linter-so-dangerous*/}

Vi·ªác b·ªè qua linter d·∫´n ƒë·∫øn nh·ªØng bug r·∫•t kh√≥ hi·ªÉu v√† kh√≥ t√¨m v√† s·ª≠a. ƒê√¢y l√† m·ªôt v√≠ d·ª•:

<Sandpack>

```js
import { useState, useEffect } from 'react';

export default function Timer() {
  const [count, setCount] = useState(0);
  const [increment, setIncrement] = useState(1);

  function onTick() {
	setCount(count + increment);
  }

  useEffect(() => {
    const id = setInterval(onTick, 1000);
    return () => clearInterval(id);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <>
      <h1>
        Counter: {count}
        <button onClick={() => setCount(0)}>Reset</button>
      </h1>
      <hr />
      <p>
        Every second, increment by:
        <button disabled={increment === 0} onClick={() => {
          setIncrement(i => i - 1);
        }}>‚Äì</button>
        <b>{increment}</b>
        <button onClick={() => {
          setIncrement(i => i + 1);
        }}>+</button>
      </p>
    </>
  );
}
```

```css
button { margin: 10px; }
```

</Sandpack>

Gi·∫£ s·ª≠ b·∫°n mu·ªën ch·∫°y Effect "ch·ªâ khi mount". B·∫°n ƒë√£ ƒë·ªçc r·∫±ng [dependency tr·ªëng (`[]`)](/learn/lifecycle-of-reactive-effects#what-an-effect-with-empty-dependencies-means) l√†m ƒëi·ªÅu ƒë√≥, v√¨ v·∫≠y b·∫°n quy·∫øt ƒë·ªãnh b·ªè qua linter, v√† c∆∞·ª°ng ch·∫ø ch·ªâ ƒë·ªãnh `[]` l√†m dependency.

B·ªô ƒë·∫øm n√†y ƒë∆∞·ª£c cho l√† s·∫Ω tƒÉng m·ªói gi√¢y theo s·ªë l∆∞·ª£ng c√≥ th·ªÉ c·∫•u h√¨nh b·∫±ng hai n√∫t. Tuy nhi√™n, v√¨ b·∫°n ƒë√£ "n√≥i d·ªëi" React r·∫±ng Effect n√†y kh√¥ng ph·ª• thu·ªôc v√†o g√¨, React m√£i m√£i ti·∫øp t·ª•c s·ª≠ d·ª•ng function `onTick` t·ª´ l·∫ßn render ban ƒë·∫ßu. [Trong l·∫ßn render ƒë√≥,](/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time) `count` l√† `0` v√† `increment` l√† `1`. ƒê√¢y l√† l√Ω do t·∫°i sao `onTick` t·ª´ l·∫ßn render ƒë√≥ lu√¥n g·ªçi `setCount(0 + 1)` m·ªói gi√¢y, v√† b·∫°n lu√¥n th·∫•y `1`. Nh·ªØng bug nh∆∞ th·∫ø n√†y kh√≥ s·ª≠a h∆°n khi ch√∫ng lan r·ªông qua nhi·ªÅu component.

Lu√¥n c√≥ m·ªôt gi·∫£i ph√°p t·ªët h∆°n vi·ªác b·ªè qua linter! ƒê·ªÉ s·ª≠a code n√†y, b·∫°n c·∫ßn th√™m `onTick` v√†o danh s√°ch dependency. (ƒê·ªÉ ƒë·∫£m b·∫£o interval ch·ªâ ƒë∆∞·ª£c thi·∫øt l·∫≠p m·ªôt l·∫ßn, [l√†m `onTick` th√†nh m·ªôt Effect Event.](/learn/separating-events-from-effects#reading-latest-props-and-state-with-effect-events))

**Ch√∫ng t√¥i khuy·∫øn ngh·ªã coi l·ªói lint dependency nh∆∞ m·ªôt l·ªói bi√™n d·ªãch. N·∫øu b·∫°n kh√¥ng b·ªè qua n√≥, b·∫°n s·∫Ω kh√¥ng bao gi·ªù th·∫•y nh·ªØng bug nh∆∞ th·∫ø n√†y.** Ph·∫ßn c√≤n l·∫°i c·ªßa trang n√†y t√†i li·ªáu h√≥a c√°c gi·∫£i ph√°p thay th·∫ø cho tr∆∞·ªùng h·ª£p n√†y v√† c√°c tr∆∞·ªùng h·ª£p kh√°c.

</DeepDive>

## Lo·∫°i b·ªè c√°c dependency kh√¥ng c·∫ßn thi·∫øt {/*removing-unnecessary-dependencies*/}

M·ªói khi b·∫°n ƒëi·ªÅu ch·ªânh c√°c dependency c·ªßa Effect ƒë·ªÉ ph·∫£n √°nh code, h√£y nh√¨n v√†o danh s√°ch dependency. C√≥ h·ª£p l√Ω kh√¥ng khi Effect ch·∫°y l·∫°i khi b·∫•t k·ª≥ dependency n√†o trong s·ªë n√†y thay ƒë·ªïi? ƒê√¥i khi, c√¢u tr·∫£ l·ªùi l√† "kh√¥ng":

* B·∫°n c√≥ th·ªÉ mu·ªën th·ª±c thi l·∫°i *c√°c ph·∫ßn kh√°c nhau* c·ªßa Effect trong nh·ªØng ƒëi·ªÅu ki·ªán kh√°c nhau.
* B·∫°n c√≥ th·ªÉ ch·ªâ mu·ªën ƒë·ªçc *gi√° tr·ªã m·ªõi nh·∫•t* c·ªßa m·ªôt s·ªë dependency thay v√¨ "ph·∫£n ·ª©ng" v·ªõi nh·ªØng thay ƒë·ªïi c·ªßa n√≥.
* M·ªôt dependency c√≥ th·ªÉ thay ƒë·ªïi qu√° th∆∞·ªùng xuy√™n *m·ªôt c√°ch kh√¥ng c·ªë √Ω* v√¨ n√≥ l√† m·ªôt object ho·∫∑c function.

ƒê·ªÉ t√¨m gi·∫£i ph√°p ƒë√∫ng, b·∫°n s·∫Ω c·∫ßn tr·∫£ l·ªùi m·ªôt v√†i c√¢u h·ªèi v·ªÅ Effect c·ªßa m√¨nh. H√£y c√πng xem qua ch√∫ng.

### Code n√†y c√≥ n√™n chuy·ªÉn sang event handler kh√¥ng? {/*should-this-code-move-to-an-event-handler*/}

ƒêi·ªÅu ƒë·∫ßu ti√™n b·∫°n n√™n nghƒ© ƒë·∫øn l√† li·ªáu code n√†y c√≥ n√™n l√† m·ªôt Effect hay kh√¥ng.

H√£y t∆∞·ªüng t∆∞·ª£ng m·ªôt form. Khi submit, b·∫°n ƒë·∫∑t bi·∫øn state `submitted` th√†nh `true`. B·∫°n c·∫ßn g·ª≠i m·ªôt POST request v√† hi·ªÉn th·ªã m·ªôt th√¥ng b√°o. B·∫°n ƒë√£ ƒë·∫∑t logic n√†y b√™n trong m·ªôt Effect "ph·∫£n ·ª©ng" v·ªõi `submitted` l√† `true`:

```js {6-8}
function Form() {
  const [submitted, setSubmitted] = useState(false);

  useEffect(() => {
    if (submitted) {
      // üî¥ Avoid: Event-specific logic inside an Effect
      post('/api/register');
      showNotification('Successfully registered!');
    }
  }, [submitted]);

  function handleSubmit() {
    setSubmitted(true);
  }

  // ...
}
```

Sau ƒë√≥, b·∫°n mu·ªën t·∫°o ki·ªÉu cho th√¥ng b√°o theo theme hi·ªán t·∫°i, v√¨ v·∫≠y b·∫°n ƒë·ªçc theme hi·ªán t·∫°i. V√¨ `theme` ƒë∆∞·ª£c khai b√°o trong th√¢n component, n√≥ l√† m·ªôt gi√° tr·ªã reactive, v√¨ v·∫≠y b·∫°n th√™m n√≥ nh∆∞ m·ªôt dependency:

```js {3,9,11}
function Form() {
  const [submitted, setSubmitted] = useState(false);
  const theme = useContext(ThemeContext);

  useEffect(() => {
    if (submitted) {
      // üî¥ Avoid: Event-specific logic inside an Effect
      post('/api/register');
      showNotification('Successfully registered!', theme);
    }
  }, [submitted, theme]); // ‚úÖ All dependencies declared

  function handleSubmit() {
    setSubmitted(true);
  }  

  // ...
}
```

B·∫±ng c√°ch l√†m ƒëi·ªÅu n√†y, b·∫°n ƒë√£ t·∫°o ra m·ªôt bug. H√£y t∆∞·ªüng t∆∞·ª£ng b·∫°n submit form tr∆∞·ªõc, sau ƒë√≥ chuy·ªÉn ƒë·ªïi gi·ªØa theme Dark v√† Light. `theme` s·∫Ω thay ƒë·ªïi, Effect s·∫Ω ch·∫°y l·∫°i, v√† v√¨ v·∫≠y n√≥ s·∫Ω hi·ªÉn th·ªã c√πng m·ªôt th√¥ng b√°o l·∫ßn n·ªØa!

**V·∫•n ƒë·ªÅ ·ªü ƒë√¢y l√† ƒëi·ªÅu n√†y kh√¥ng n√™n l√† m·ªôt Effect ngay t·ª´ ƒë·∫ßu.** B·∫°n mu·ªën g·ª≠i POST request n√†y v√† hi·ªÉn th·ªã th√¥ng b√°o ƒë·ªÉ ph·∫£n h·ªìi vi·ªác *submit form,* ƒë√≥ l√† m·ªôt t∆∞∆°ng t√°c c·ª• th·ªÉ. ƒê·ªÉ ch·∫°y m·ªôt s·ªë code ph·∫£n h·ªìi t∆∞∆°ng t√°c c·ª• th·ªÉ, h√£y ƒë·∫∑t logic ƒë√≥ tr·ª±c ti·∫øp v√†o event handler t∆∞∆°ng ·ª©ng:

```js {6-7}
function Form() {
  const theme = useContext(ThemeContext);

  function handleSubmit() {
    // ‚úÖ Good: Event-specific logic is called from event handlers
    post('/api/register');
    showNotification('Successfully registered!', theme);
  }  

  // ...
}
```

B√¢y gi·ªù code ·ªü trong event handler, n√≥ kh√¥ng ph·∫£i l√† reactive--v√¨ v·∫≠y n√≥ s·∫Ω ch·ªâ ch·∫°y khi ng∆∞·ªùi d√πng submit form. ƒê·ªçc th√™m v·ªÅ [l·ª±a ch·ªçn gi·ªØa event handler v√† Effect](/learn/separating-events-from-effects#reactive-values-and-reactive-logic) v√† [c√°ch x√≥a c√°c Effect kh√¥ng c·∫ßn thi·∫øt.](/learn/you-might-not-need-an-effect)

### Effect c·ªßa b·∫°n c√≥ ƒëang l√†m nhi·ªÅu vi·ªác kh√¥ng li√™n quan kh√¥ng? {/*is-your-effect-doing-several-unrelated-things*/}

C√¢u h·ªèi ti·∫øp theo b·∫°n n√™n t·ª± h·ªèi l√† li·ªáu Effect c·ªßa b·∫°n c√≥ ƒëang l√†m nhi·ªÅu vi·ªác kh√¥ng li√™n quan.

H√£y t∆∞·ªüng t∆∞·ª£ng b·∫°n ƒëang t·∫°o m·ªôt form v·∫≠n chuy·ªÉn n∆°i ng∆∞·ªùi d√πng c·∫ßn ch·ªçn th√†nh ph·ªë v√† khu v·ª±c c·ªßa h·ªç. B·∫°n fetch danh s√°ch `cities` t·ª´ server theo `country` ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ hi·ªÉn th·ªã ch√∫ng trong dropdown:

```js
function ShippingForm({ country }) {
  const [cities, setCities] = useState(null);
  const [city, setCity] = useState(null);

  useEffect(() => {
    let ignore = false;
    fetch(`/api/cities?country=${country}`)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setCities(json);
        }
      });
    return () => {
      ignore = true;
    };
  }, [country]); // ‚úÖ All dependencies declared

  // ...
```

ƒê√¢y l√† m·ªôt v√≠ d·ª• t·ªët v·ªÅ [fetch data trong Effect.](/learn/you-might-not-need-an-effect#fetching-data) B·∫°n ƒëang ƒë·ªìng b·ªô state `cities` v·ªõi m·∫°ng theo prop `country`. B·∫°n kh√¥ng th·ªÉ l√†m ƒëi·ªÅu n√†y trong event handler v√¨ b·∫°n c·∫ßn fetch ngay khi `ShippingForm` ƒë∆∞·ª£c hi·ªÉn th·ªã v√† b·∫•t c·ª© khi n√†o `country` thay ƒë·ªïi (b·∫•t k·ªÉ t∆∞∆°ng t√°c n√†o g√¢y ra).

B√¢y gi·ªù, gi·∫£ s·ª≠ b·∫°n ƒëang th√™m m·ªôt select box th·ª© hai cho c√°c khu v·ª±c th√†nh ph·ªë, s·∫Ω fetch `areas` cho `city` hi·ªán t·∫°i ƒë∆∞·ª£c ch·ªçn. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu b·∫±ng c√°ch th√™m m·ªôt cu·ªôc g·ªçi `fetch` th·ª© hai cho danh s√°ch c√°c khu v·ª±c b√™n trong c√πng m·ªôt Effect:

```js {15-24,28}
function ShippingForm({ country }) {
  const [cities, setCities] = useState(null);
  const [city, setCity] = useState(null);
  const [areas, setAreas] = useState(null);

  useEffect(() => {
    let ignore = false;
    fetch(`/api/cities?country=${country}`)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setCities(json);
        }
      });
    // üî¥ Avoid: A single Effect synchronizes two independent processes
    if (city) {
      fetch(`/api/areas?city=${city}`)
        .then(response => response.json())
        .then(json => {
          if (!ignore) {
            setAreas(json);
          }
        });
    }
    return () => {
      ignore = true;
    };
  }, [country, city]); // ‚úÖ All dependencies declared

  // ...
```

Tuy nhi√™n, v√¨ Effect b√¢y gi·ªù s·ª≠ d·ª•ng bi·∫øn state `city`, b·∫°n ƒë√£ ph·∫£i th√™m `city` v√†o danh s√°ch dependency. ƒêi·ªÅu ƒë√≥, l·∫ßn l∆∞·ª£t, g√¢y ra m·ªôt v·∫•n ƒë·ªÅ: khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt th√†nh ph·ªë kh√°c, Effect s·∫Ω ch·∫°y l·∫°i v√† g·ªçi `fetchCities(country)`. K·∫øt qu·∫£ l√†, b·∫°n s·∫Ω fetch l·∫°i danh s√°ch c√°c th√†nh ph·ªë m·ªôt c√°ch kh√¥ng c·∫ßn thi·∫øt nhi·ªÅu l·∫ßn.

**V·∫•n ƒë·ªÅ v·ªõi code n√†y l√† b·∫°n ƒëang ƒë·ªìng b·ªô hai th·ª© kh√°c nhau kh√¥ng li√™n quan:**

1. B·∫°n mu·ªën ƒë·ªìng b·ªô state `cities` v·ªõi m·∫°ng d·ª±a tr√™n prop `country`.
1. B·∫°n mu·ªën ƒë·ªìng b·ªô state `areas` v·ªõi m·∫°ng d·ª±a tr√™n state `city`.

Chia logic th√†nh hai Effect, m·ªói Effect ph·∫£n ·ª©ng v·ªõi prop m√† n√≥ c·∫ßn ƒë·ªìng b·ªô:

```js {19-33}
function ShippingForm({ country }) {
  const [cities, setCities] = useState(null);
  useEffect(() => {
    let ignore = false;
    fetch(`/api/cities?country=${country}`)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setCities(json);
        }
      });
    return () => {
      ignore = true;
    };
  }, [country]); // ‚úÖ All dependencies declared

  const [city, setCity] = useState(null);
  const [areas, setAreas] = useState(null);
  useEffect(() => {
    if (city) {
      let ignore = false;
      fetch(`/api/areas?city=${city}`)
        .then(response => response.json())
        .then(json => {
          if (!ignore) {
            setAreas(json);
          }
        });
      return () => {
        ignore = true;
      };
    }
  }, [city]); // ‚úÖ All dependencies declared

  // ...
```

B√¢y gi·ªù Effect ƒë·∫ßu ti√™n ch·ªâ ch·∫°y l·∫°i n·∫øu `country` thay ƒë·ªïi, trong khi Effect th·ª© hai ch·∫°y l·∫°i khi `city` thay ƒë·ªïi. B·∫°n ƒë√£ t√°ch ch√∫ng theo m·ª•c ƒë√≠ch: hai th·ª© kh√°c nhau ƒë∆∞·ª£c ƒë·ªìng b·ªô b·ªüi hai Effect ri√™ng bi·ªát. Hai Effect ri√™ng bi·ªát c√≥ hai danh s√°ch dependency ri√™ng bi·ªát, v√¨ v·∫≠y ch√∫ng s·∫Ω kh√¥ng k√≠ch ho·∫°t l·∫´n nhau m·ªôt c√°ch kh√¥ng c·ªë √Ω.

Code cu·ªëi c√πng d√†i h∆°n b·∫£n g·ªëc, nh∆∞ng t√°ch c√°c Effect n√†y v·∫´n ƒë√∫ng. [M·ªói Effect n√™n ƒë·∫°i di·ªán cho m·ªôt qu√° tr√¨nh ƒë·ªìng b·ªô ƒë·ªôc l·∫≠p.](/learn/lifecycle-of-reactive-effects#each-effect-represents-a-separate-synchronization-process) Trong v√≠ d·ª• n√†y, x√≥a m·ªôt Effect kh√¥ng ph√° v·ª° logic c·ªßa Effect kh√°c. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† ch√∫ng *ƒë·ªìng b·ªô nh·ªØng th·ª© kh√°c nhau,* v√† vi·ªác t√°ch ch√∫ng ra l√† t·ªët. N·∫øu b·∫°n lo l·∫Øng v·ªÅ vi·ªác tr√πng l·∫∑p, b·∫°n c√≥ th·ªÉ c·∫£i thi·ªán code n√†y b·∫±ng c√°ch [tr√≠ch xu·∫•t logic l·∫∑p l·∫°i th√†nh m·ªôt custom Hook.](/learn/reusing-logic-with-custom-hooks#when-to-use-custom-hooks)

### B·∫°n c√≥ ƒëang ƒë·ªçc m·ªôt s·ªë state ƒë·ªÉ t√≠nh to√°n state ti·∫øp theo kh√¥ng? {/*are-you-reading-some-state-to-calculate-the-next-state*/}

Effect n√†y c·∫≠p nh·∫≠t bi·∫øn state `messages` v·ªõi m·ªôt array m·ªõi ƒë∆∞·ª£c t·∫°o m·ªói khi c√≥ tin nh·∫Øn m·ªõi ƒë·∫øn:

```js {2,6-8}
function ChatRoom({ roomId }) {
  const [messages, setMessages] = useState([]);
  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      setMessages([...messages, receivedMessage]);
    });
    // ...
```

N√≥ s·ª≠ d·ª•ng bi·∫øn `messages` ƒë·ªÉ [t·∫°o m·ªôt array m·ªõi](/learn/updating-arrays-in-state) b·∫Øt ƒë·∫ßu v·ªõi t·∫•t c·∫£ c√°c tin nh·∫Øn hi·ªán c√≥ v√† th√™m tin nh·∫Øn m·ªõi v√†o cu·ªëi. Tuy nhi√™n, v√¨ `messages` l√† m·ªôt gi√° tr·ªã reactive ƒë∆∞·ª£c ƒë·ªçc b·ªüi Effect, n√≥ ph·∫£i l√† m·ªôt dependency:

```js {7,10}
function ChatRoom({ roomId }) {
  const [messages, setMessages] = useState([]);
  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      setMessages([...messages, receivedMessage]);
    });
    return () => connection.disconnect();
  }, [roomId, messages]); // ‚úÖ All dependencies declared
  // ...
```

V√† vi·ªác l√†m `messages` th√†nh dependency g√¢y ra m·ªôt v·∫•n ƒë·ªÅ.

M·ªói khi b·∫°n nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn, `setMessages()` khi·∫øn component render l·∫°i v·ªõi m·ªôt array `messages` m·ªõi bao g·ªìm tin nh·∫Øn ƒë√£ nh·∫≠n. Tuy nhi√™n, v√¨ Effect n√†y b√¢y gi·ªù ph·ª• thu·ªôc v√†o `messages`, ƒëi·ªÅu n√†y c≈©ng s·∫Ω ƒë·ªìng b·ªô l·∫°i Effect. V√¨ v·∫≠y, m·ªói tin nh·∫Øn m·ªõi s·∫Ω l√†m cho chat k·∫øt n·ªëi l·∫°i. Ng∆∞·ªùi d√πng s·∫Ω kh√¥ng th√≠ch ƒëi·ªÅu ƒë√≥!

ƒê·ªÉ s·ª≠a v·∫•n ƒë·ªÅ, ƒë·ª´ng ƒë·ªçc `messages` b√™n trong Effect. Thay v√†o ƒë√≥, truy·ªÅn m·ªôt [updater function](/reference/react/useState#updating-state-based-on-the-previous-state) cho `setMessages`:

```js {7,10}
function ChatRoom({ roomId }) {
  const [messages, setMessages] = useState([]);
  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      setMessages(msgs => [...msgs, receivedMessage]);
    });
    return () => connection.disconnect();
  }, [roomId]); // ‚úÖ All dependencies declared
  // ...
```

**L∆∞u √Ω c√°ch Effect c·ªßa b·∫°n kh√¥ng ƒë·ªçc bi·∫øn `messages` ch√∫t n√†o b√¢y gi·ªù.** B·∫°n ch·ªâ c·∫ßn truy·ªÅn m·ªôt updater function nh∆∞ `msgs => [...msgs, receivedMessage]`. React [ƒë·∫∑t updater function c·ªßa b·∫°n v√†o m·ªôt h√†ng ƒë·ª£i](/learn/queueing-a-series-of-state-updates) v√† s·∫Ω cung c·∫•p tham s·ªë `msgs` cho n√≥ trong l·∫ßn render ti·∫øp theo. ƒê√¢y l√† l√Ω do t·∫°i sao b·∫£n th√¢n Effect kh√¥ng c·∫ßn ph·ª• thu·ªôc v√†o `messages` n·ªØa. K·∫øt qu·∫£ c·ªßa vi·ªác s·ª≠a n√†y, vi·ªác nh·∫≠n tin nh·∫Øn chat s·∫Ω kh√¥ng c√≤n l√†m cho chat k·∫øt n·ªëi l·∫°i.

### B·∫°n c√≥ mu·ªën ƒë·ªçc m·ªôt gi√° tr·ªã m√† kh√¥ng "ph·∫£n ·ª©ng" v·ªõi nh·ªØng thay ƒë·ªïi c·ªßa n√≥ kh√¥ng? {/*do-you-want-to-read-a-value-without-reacting-to-its-changes*/}

<Wip>

Ph·∫ßn n√†y m√¥ t·∫£ m·ªôt **API th·ª≠ nghi·ªám ch∆∞a ƒë∆∞·ª£c ph√°t h√†nh** trong phi√™n b·∫£n ·ªïn ƒë·ªãnh c·ªßa React.

</Wip>

Gi·∫£ s·ª≠ b·∫°n mu·ªën ph√°t √¢m thanh khi ng∆∞·ªùi d√πng nh·∫≠n tin nh·∫Øn m·ªõi tr·ª´ khi `isMuted` l√† `true`:

```js {3,10-12}
function ChatRoom({ roomId }) {
  const [messages, setMessages] = useState([]);
  const [isMuted, setIsMuted] = useState(false);

  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      setMessages(msgs => [...msgs, receivedMessage]);
      if (!isMuted) {
        playSound();
      }
    });
    // ...
```

V√¨ Effect c·ªßa b·∫°n b√¢y gi·ªù s·ª≠ d·ª•ng `isMuted` trong code, b·∫°n ph·∫£i th√™m n√≥ v√†o dependency:

```js {10,15}
function ChatRoom({ roomId }) {
  const [messages, setMessages] = useState([]);
  const [isMuted, setIsMuted] = useState(false);

  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      setMessages(msgs => [...msgs, receivedMessage]);
      if (!isMuted) {
        playSound();
      }
    });
    return () => connection.disconnect();
  }, [roomId, isMuted]); // ‚úÖ All dependencies declared
  // ...
```

V·∫•n ƒë·ªÅ l√† m·ªói khi `isMuted` thay ƒë·ªïi (v√≠ d·ª•, khi ng∆∞·ªùi d√πng nh·∫•n n√∫t "Muted"), Effect s·∫Ω ƒë·ªìng b·ªô l·∫°i v√† k·∫øt n·ªëi l·∫°i v·ªõi chat. ƒê√¢y kh√¥ng ph·∫£i l√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng mong mu·ªën! (Trong v√≠ d·ª• n√†y, ngay c·∫£ vi·ªác v√¥ hi·ªáu h√≥a linter c≈©ng kh√¥ng ho·∫°t ƒë·ªông--n·∫øu b·∫°n l√†m v·∫≠y, `isMuted` s·∫Ω b·ªã "k·∫πt" v·ªõi gi√° tr·ªã c≈©.)

ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, b·∫°n c·∫ßn tr√≠ch xu·∫•t logic kh√¥ng n√™n l√† reactive ra kh·ªèi Effect. B·∫°n kh√¥ng mu·ªën Effect n√†y "ph·∫£n ·ª©ng" v·ªõi nh·ªØng thay ƒë·ªïi trong `isMuted`. [Di chuy·ªÉn ƒëo·∫°n logic kh√¥ng reactive n√†y v√†o m·ªôt Effect Event:](/learn/separating-events-from-effects#declaring-an-effect-event)

```js {1,7-12,18,21}
import { useState, useEffect, useEffectEvent } from 'react';

function ChatRoom({ roomId }) {
  const [messages, setMessages] = useState([]);
  const [isMuted, setIsMuted] = useState(false);

  const onMessage = useEffectEvent(receivedMessage => {
    setMessages(msgs => [...msgs, receivedMessage]);
    if (!isMuted) {
      playSound();
    }
  });

  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      onMessage(receivedMessage);
    });
    return () => connection.disconnect();
  }, [roomId]); // ‚úÖ All dependencies declared
  // ...
```

Effect Event cho ph√©p b·∫°n chia m·ªôt Effect th√†nh c√°c ph·∫ßn reactive (n√™n "ph·∫£n ·ª©ng" v·ªõi c√°c gi√° tr·ªã reactive nh∆∞ `roomId` v√† nh·ªØng thay ƒë·ªïi c·ªßa ch√∫ng) v√† c√°c ph·∫ßn kh√¥ng reactive (ch·ªâ ƒë·ªçc c√°c gi√° tr·ªã m·ªõi nh·∫•t c·ªßa ch√∫ng, nh∆∞ `onMessage` ƒë·ªçc `isMuted`). **B√¢y gi·ªù b·∫°n ƒë·ªçc `isMuted` b√™n trong Effect Event, n√≥ kh√¥ng c·∫ßn ph·∫£i l√† dependency c·ªßa Effect.** K·∫øt qu·∫£ l√†, chat s·∫Ω kh√¥ng k·∫øt n·ªëi l·∫°i khi b·∫°n b·∫≠t/t·∫Øt c√†i ƒë·∫∑t "Muted", gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ ban ƒë·∫ßu!

#### Bao b·ªçc event handler t·ª´ props {/*wrapping-an-event-handler-from-the-props*/}

B·∫°n c√≥ th·ªÉ g·∫∑p ph·∫£i v·∫•n ƒë·ªÅ t∆∞∆°ng t·ª± khi component nh·∫≠n event handler nh∆∞ m·ªôt prop:

```js {1,8,11}
function ChatRoom({ roomId, onReceiveMessage }) {
  const [messages, setMessages] = useState([]);

  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      onReceiveMessage(receivedMessage);
    });
    return () => connection.disconnect();
  }, [roomId, onReceiveMessage]); // ‚úÖ All dependencies declared
  // ...
```

Gi·∫£ s·ª≠ component cha truy·ªÅn m·ªôt function `onReceiveMessage` *kh√°c* trong m·ªói l·∫ßn render:

```js {3-5}
<ChatRoom
  roomId={roomId}
  onReceiveMessage={receivedMessage => {
    // ...
  }}
/>
```

V√¨ `onReceiveMessage` l√† m·ªôt dependency, n√≥ s·∫Ω khi·∫øn Effect ƒë·ªìng b·ªô l·∫°i sau m·ªói l·∫ßn component cha render l·∫°i. ƒêi·ªÅu n√†y s·∫Ω l√†m cho n√≥ k·∫øt n·ªëi l·∫°i v·ªõi chat. ƒê·ªÉ gi·∫£i quy·∫øt ƒëi·ªÅu n√†y, h√£y bao b·ªçc cu·ªôc g·ªçi trong Effect Event:

```js {4-6,12,15}
function ChatRoom({ roomId, onReceiveMessage }) {
  const [messages, setMessages] = useState([]);

  const onMessage = useEffectEvent(receivedMessage => {
    onReceiveMessage(receivedMessage);
  });

  useEffect(() => {
    const connection = createConnection();
    connection.connect();
    connection.on('message', (receivedMessage) => {
      onMessage(receivedMessage);
    });
    return () => connection.disconnect();
  }, [roomId]); // ‚úÖ All dependencies declared
  // ...
```

Effect Event kh√¥ng ph·∫£i l√† reactive, v√¨ v·∫≠y b·∫°n kh√¥ng c·∫ßn ch·ªâ ƒë·ªãnh ch√∫ng l√†m dependency. K·∫øt qu·∫£ l√†, chat s·∫Ω kh√¥ng c√≤n k·∫øt n·ªëi l·∫°i ngay c·∫£ khi component cha truy·ªÅn m·ªôt function kh√°c trong m·ªói l·∫ßn render l·∫°i.

#### T√°ch code reactive v√† kh√¥ng reactive {/*separating-reactive-and-non-reactive-code*/}

Trong v√≠ d·ª• n√†y, b·∫°n mu·ªën ghi log m·ªôt l·∫ßn visit m·ªói khi `roomId` thay ƒë·ªïi. B·∫°n mu·ªën bao g·ªìm `notificationCount` hi·ªán t·∫°i v·ªõi m·ªçi log, nh∆∞ng b·∫°n *kh√¥ng* mu·ªën m·ªôt thay ƒë·ªïi trong `notificationCount` k√≠ch ho·∫°t s·ª± ki·ªán log.

Gi·∫£i ph√°p m·ªôt l·∫ßn n·ªØa l√† t√°ch code kh√¥ng reactive v√†o Effect Event:

```js {2-4,7}
function Chat({ roomId, notificationCount }) {
  const onVisit = useEffectEvent(visitedRoomId => {
    logVisit(visitedRoomId, notificationCount);
  });

  useEffect(() => {
    onVisit(roomId);
  }, [roomId]); // ‚úÖ All dependencies declared
  // ...
}
```

B·∫°n mu·ªën logic c·ªßa m√¨nh reactive ƒë·ªëi v·ªõi `roomId`, v√¨ v·∫≠y b·∫°n ƒë·ªçc `roomId` b√™n trong Effect. Tuy nhi√™n, b·∫°n kh√¥ng mu·ªën thay ƒë·ªïi `notificationCount` ghi log th√™m visit, v√¨ v·∫≠y b·∫°n ƒë·ªçc `notificationCount` b√™n trong Effect Event. [T√¨m hi·ªÉu th√™m v·ªÅ vi·ªác ƒë·ªçc props v√† state m·ªõi nh·∫•t t·ª´ Effect b·∫±ng Effect Event.](/learn/separating-events-from-effects#reading-latest-props-and-state-with-effect-events)

### C√≥ gi√° tr·ªã reactive n√†o thay ƒë·ªïi m·ªôt c√°ch kh√¥ng c·ªë √Ω kh√¥ng? {/*does-some-reactive-value-change-unintentionally*/}

ƒê√¥i khi, b·∫°n *th·ª±c s·ª±* mu·ªën Effect "ph·∫£n ·ª©ng" v·ªõi m·ªôt gi√° tr·ªã nh·∫•t ƒë·ªãnh, nh∆∞ng gi√° tr·ªã ƒë√≥ thay ƒë·ªïi th∆∞·ªùng xuy√™n h∆°n b·∫°n mu·ªën--v√† c√≥ th·ªÉ kh√¥ng ph·∫£n √°nh b·∫•t k·ª≥ thay ƒë·ªïi th·ª±c t·∫ø n√†o t·ª´ g√≥c ƒë·ªô ng∆∞·ªùi d√πng. V√≠ d·ª•, gi·∫£ s·ª≠ b·∫°n t·∫°o m·ªôt object `options` trong th√¢n component c·ªßa m√¨nh, v√† sau ƒë√≥ ƒë·ªçc object ƒë√≥ t·ª´ b√™n trong Effect:

```js {3-6,9}
function ChatRoom({ roomId }) {
  // ...
  const options = {
    serverUrl: serverUrl,
    roomId: roomId
  };

  useEffect(() => {
    const connection = createConnection(options);
    connection.connect();
    // ...
```

Object n√†y ƒë∆∞·ª£c khai b√°o trong th√¢n component, v√¨ v·∫≠y n√≥ l√† m·ªôt [gi√° tr·ªã reactive.](/learn/lifecycle-of-reactive-effects#effects-react-to-reactive-values) Khi b·∫°n ƒë·ªçc m·ªôt gi√° tr·ªã reactive nh∆∞ th·∫ø n√†y b√™n trong Effect, b·∫°n khai b√°o n√≥ nh∆∞ m·ªôt dependency. ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o Effect c·ªßa b·∫°n "ph·∫£n ·ª©ng" v·ªõi nh·ªØng thay ƒë·ªïi c·ªßa n√≥:

```js {3,6}
  // ...
  useEffect(() => {
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [options]); // ‚úÖ All dependencies declared
  // ...
```

Vi·ªác khai b√°o n√≥ nh∆∞ m·ªôt dependency l√† r·∫•t quan tr·ªçng! ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o, v√≠ d·ª•, n·∫øu `roomId` thay ƒë·ªïi, Effect c·ªßa b·∫°n s·∫Ω k·∫øt n·ªëi l·∫°i v·ªõi chat v·ªõi `options` m·ªõi. Tuy nhi√™n, c≈©ng c√≥ m·ªôt v·∫•n ƒë·ªÅ v·ªõi code ·ªü tr√™n. ƒê·ªÉ th·∫•y ƒëi·ªÅu ƒë√≥, h√£y th·ª≠ g√µ v√†o input trong sandbox b√™n d∆∞·ªõi, v√† xem ƒëi·ªÅu g√¨ x·∫£y ra trong console:

<Sandpack>

```js
import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  // Temporarily disable the linter to demonstrate the problem
  // eslint-disable-next-line react-hooks/exhaustive-deps
  const options = {
    serverUrl: serverUrl,
    roomId: roomId
  };

  useEffect(() => {
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [options]);

  return (
    <>
      <h1>Welcome to the {roomId} room!</h1>
      <input value={message} onChange={e => setMessage(e.target.value)} />
    </>
  );
}

export default function App() {
  const [roomId, setRoomId] = useState('general');
  return (
    <>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom roomId={roomId} />
    </>
  );
}
```

```js src/chat.js
export function createConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
input { display: block; margin-bottom: 20px; }
button { margin-left: 10px; }
```

</Sandpack>

Trong sandbox ·ªü tr√™n, input ch·ªâ c·∫≠p nh·∫≠t bi·∫øn state `message`. T·ª´ g√≥c ƒë·ªô ng∆∞·ªùi d√πng, ƒëi·ªÅu n√†y kh√¥ng n√™n ·∫£nh h∆∞·ªüng ƒë·∫øn k·∫øt n·ªëi chat. Tuy nhi√™n, m·ªói khi b·∫°n c·∫≠p nh·∫≠t `message`, component c·ªßa b·∫°n s·∫Ω render l·∫°i. Khi component render l·∫°i, code b√™n trong n√≥ ch·∫°y l·∫°i t·ª´ ƒë·∫ßu.

M·ªôt object `options` m·ªõi ƒë∆∞·ª£c t·∫°o t·ª´ ƒë·∫ßu m·ªói khi `ChatRoom` component render l·∫°i. React th·∫•y r·∫±ng object `options` l√† m·ªôt *object kh√°c* v·ªõi object `options` ƒë∆∞·ª£c t·∫°o trong l·∫ßn render tr∆∞·ªõc. ƒê√¢y l√† l√Ω do t·∫°i sao n√≥ ƒë·ªìng b·ªô l·∫°i Effect c·ªßa b·∫°n (ph·ª• thu·ªôc v√†o `options`), v√† chat k·∫øt n·ªëi l·∫°i khi b·∫°n g√µ.

**V·∫•n ƒë·ªÅ n√†y ch·ªâ ·∫£nh h∆∞·ªüng ƒë·∫øn object v√† function. Trong JavaScript, m·ªói object v√† function m·ªõi ƒë∆∞·ª£c t·∫°o ra ƒë·ªÅu ƒë∆∞·ª£c coi l√† kh√°c bi·ªát v·ªõi t·∫•t c·∫£ c√°c object/function kh√°c. Kh√¥ng quan tr·ªçng n·ªôi dung b√™n trong ch√∫ng c√≥ gi·ªëng nhau hay kh√¥ng!**

```js {7-8}
// During the first render
const options1 = { serverUrl: 'https://localhost:1234', roomId: 'music' };

// During the next render
const options2 = { serverUrl: 'https://localhost:1234', roomId: 'music' };

// These are two different objects!
console.log(Object.is(options1, options2)); // false
```

**C√°c dependency l√† object v√† function c√≥ th·ªÉ khi·∫øn Effect ƒë·ªìng b·ªô l·∫°i th∆∞·ªùng xuy√™n h∆°n b·∫°n c·∫ßn.** 

ƒê√¢y l√† l√Ω do t·∫°i sao, b·∫•t c·ª© khi n√†o c√≥ th·ªÉ, b·∫°n n√™n c·ªë g·∫Øng tr√°nh c√°c object v√† function l√†m dependency c·ªßa Effect. Thay v√†o ƒë√≥, h√£y th·ª≠ di chuy·ªÉn ch√∫ng ra ngo√†i component, v√†o trong Effect, ho·∫∑c tr√≠ch xu·∫•t c√°c gi√° tr·ªã nguy√™n th·ªßy t·ª´ ch√∫ng.

#### Di chuy·ªÉn c√°c object v√† function tƒ©nh ra ngo√†i component {/*move-static-objects-and-functions-outside-your-component*/}

N·∫øu object kh√¥ng ph·ª• thu·ªôc v√†o b·∫•t k·ª≥ props v√† state n√†o, b·∫°n c√≥ th·ªÉ di chuy·ªÉn object ƒë√≥ ra ngo√†i component:

```js {1-4,13}
const options = {
  serverUrl: 'https://localhost:1234',
  roomId: 'music'
};

function ChatRoom() {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, []); // ‚úÖ All dependencies declared
  // ...
```

B·∫±ng c√°ch n√†y, b·∫°n *ch·ª©ng minh* cho linter r·∫±ng n√≥ kh√¥ng reactive. N√≥ kh√¥ng th·ªÉ thay ƒë·ªïi do k·∫øt qu·∫£ c·ªßa vi·ªác render l·∫°i, v√¨ v·∫≠y n√≥ kh√¥ng c·∫ßn ph·∫£i l√† m·ªôt dependency. B√¢y gi·ªù vi·ªác render l·∫°i `ChatRoom` s·∫Ω kh√¥ng khi·∫øn Effect c·ªßa b·∫°n ƒë·ªìng b·ªô l·∫°i.

ƒêi·ªÅu n√†y c≈©ng ho·∫°t ƒë·ªông cho function:

```js {1-6,12}
function createOptions() {
  return {
    serverUrl: 'https://localhost:1234',
    roomId: 'music'
  };
}

function ChatRoom() {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const options = createOptions();
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, []); // ‚úÖ All dependencies declared
  // ...
```

V√¨ `createOptions` ƒë∆∞·ª£c khai b√°o b√™n ngo√†i component c·ªßa b·∫°n, n√≥ kh√¥ng ph·∫£i l√† m·ªôt gi√° tr·ªã reactive. ƒê√¢y l√† l√Ω do t·∫°i sao n√≥ kh√¥ng c·∫ßn ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh trong c√°c dependency c·ªßa Effect, v√† t·∫°i sao n√≥ s·∫Ω kh√¥ng bao gi·ªù khi·∫øn Effect c·ªßa b·∫°n ƒë·ªìng b·ªô l·∫°i.

#### Di chuy·ªÉn c√°c object v√† function ƒë·ªông v√†o trong Effect {/*move-dynamic-objects-and-functions-inside-your-effect*/}

N·∫øu object c·ªßa b·∫°n ph·ª• thu·ªôc v√†o m·ªôt s·ªë gi√° tr·ªã reactive c√≥ th·ªÉ thay ƒë·ªïi do k·∫øt qu·∫£ c·ªßa vi·ªác render l·∫°i, nh∆∞ m·ªôt prop `roomId`, b·∫°n kh√¥ng th·ªÉ k√©o n√≥ ra *b√™n ngo√†i* component. Tuy nhi√™n, b·∫°n c√≥ th·ªÉ di chuy·ªÉn vi·ªác t·∫°o n√≥ *v√†o trong* code Effect c·ªßa b·∫°n:

```js {7-10,11,14}
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // ‚úÖ All dependencies declared
  // ...
```

B√¢y gi·ªù `options` ƒë∆∞·ª£c khai b√°o b√™n trong Effect c·ªßa b·∫°n, n√≥ kh√¥ng c√≤n l√† dependency c·ªßa Effect n·ªØa. Thay v√†o ƒë√≥, gi√° tr·ªã reactive duy nh·∫•t ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi Effect l√† `roomId`. V√¨ `roomId` kh√¥ng ph·∫£i l√† object ho·∫∑c function, b·∫°n c√≥ th·ªÉ ch·∫Øc ch·∫Øn r·∫±ng n√≥ s·∫Ω kh√¥ng *v√¥ t√¨nh* kh√°c bi·ªát. Trong JavaScript, number v√† string ƒë∆∞·ª£c so s√°nh theo n·ªôi dung c·ªßa ch√∫ng:

```js {7-8}
// During the first render
const roomId1 = 'music';

// During the next render
const roomId2 = 'music';

// These two strings are the same!
console.log(Object.is(roomId1, roomId2)); // true
```

Nh·ªù v√†o s·ª≠a ch·ªØa n√†y, chat kh√¥ng c√≤n k·∫øt n·ªëi l·∫°i n·∫øu b·∫°n ch·ªânh s·ª≠a input:

<Sandpack>

```js
import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]);

  return (
    <>
      <h1>Welcome to the {roomId} room!</h1>
      <input value={message} onChange={e => setMessage(e.target.value)} />
    </>
  );
}

export default function App() {
  const [roomId, setRoomId] = useState('general');
  return (
    <>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom roomId={roomId} />
    </>
  );
}
```

```js src/chat.js
export function createConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
input { display: block; margin-bottom: 20px; }
button { margin-left: 10px; }
```

</Sandpack>

Tuy nhi√™n, n√≥ *c√≥* k·∫øt n·ªëi l·∫°i khi b·∫°n thay ƒë·ªïi dropdown `roomId`, nh∆∞ b·∫°n mong ƒë·ª£i.

ƒêi·ªÅu n√†y c≈©ng ho·∫°t ƒë·ªông v·ªõi c√°c function:

```js {7-12,14}
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  useEffect(() => {
    function createOptions() {
      return {
        serverUrl: serverUrl,
        roomId: roomId
      };
    }

    const options = createOptions();
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // ‚úÖ All dependencies declared
  // ...
```

B·∫°n c√≥ th·ªÉ vi·∫øt c√°c function c·ªßa ri√™ng m√¨nh ƒë·ªÉ nh√≥m c√°c ph·∫ßn logic b√™n trong Effect. Mi·ªÖn l√† b·∫°n c≈©ng khai b√°o ch√∫ng *b√™n trong* Effect, ch√∫ng kh√¥ng ph·∫£i l√† gi√° tr·ªã reactive, v√† v√¨ v·∫≠y ch√∫ng kh√¥ng c·∫ßn ph·∫£i l√† dependency c·ªßa Effect.

#### ƒê·ªçc c√°c gi√° tr·ªã nguy√™n th·ªßy t·ª´ object {/*read-primitive-values-from-objects*/}

ƒê√¥i khi, b·∫°n c√≥ th·ªÉ nh·∫≠n m·ªôt object t·ª´ props:

```js {1,5,8}
function ChatRoom({ options }) {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [options]); // ‚úÖ All dependencies declared
  // ...
```

R·ªßi ro ·ªü ƒë√¢y l√† component cha s·∫Ω t·∫°o object trong qu√° tr√¨nh rendering:

```js {3-6}
<ChatRoom
  roomId={roomId}
  options={{
    serverUrl: serverUrl,
    roomId: roomId
  }}
/>
```

ƒêi·ªÅu n√†y s·∫Ω khi·∫øn Effect c·ªßa b·∫°n k·∫øt n·ªëi l·∫°i m·ªói khi component cha render l·∫°i. ƒê·ªÉ s·ª≠a ƒëi·ªÅu n√†y, h√£y ƒë·ªçc th√¥ng tin t·ª´ object *b√™n ngo√†i* Effect, v√† tr√°nh c√≥ c√°c dependency l√† object v√† function:

```js {4,7-8,12}
function ChatRoom({ options }) {
  const [message, setMessage] = useState('');

  const { roomId, serverUrl } = options;
  useEffect(() => {
    const connection = createConnection({
      roomId: roomId,
      serverUrl: serverUrl
    });
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]); // ‚úÖ All dependencies declared
  // ...
```

Logic tr·ªü n√™n h∆°i l·∫∑p l·∫°i (b·∫°n ƒë·ªçc m·ªôt s·ªë gi√° tr·ªã t·ª´ object b√™n ngo√†i Effect, v√† sau ƒë√≥ t·∫°o m·ªôt object v·ªõi c√°c gi√° tr·ªã gi·ªëng nhau b√™n trong Effect). Nh∆∞ng n√≥ l√†m cho vi·ªác Effect c·ªßa b·∫°n *th·ª±c s·ª±* ph·ª• thu·ªôc v√†o th√¥ng tin g√¨ tr·ªü n√™n r·∫•t r√µ r√†ng. N·∫øu m·ªôt object ƒë∆∞·ª£c t·∫°o l·∫°i m·ªôt c√°ch kh√¥ng c·ªë √Ω b·ªüi component cha, chat s·∫Ω kh√¥ng k·∫øt n·ªëi l·∫°i. Tuy nhi√™n, n·∫øu `options.roomId` ho·∫∑c `options.serverUrl` th·ª±c s·ª± kh√°c, chat s·∫Ω k·∫øt n·ªëi l·∫°i.

#### T√≠nh to√°n c√°c gi√° tr·ªã nguy√™n th·ªßy t·ª´ function {/*calculate-primitive-values-from-functions*/}

C√°ch ti·∫øp c·∫≠n t∆∞∆°ng t·ª± c√≥ th·ªÉ ho·∫°t ƒë·ªông cho function. V√≠ d·ª•, gi·∫£ s·ª≠ component cha truy·ªÅn m·ªôt function:

```js {3-8}
<ChatRoom
  roomId={roomId}
  getOptions={() => {
    return {
      serverUrl: serverUrl,
      roomId: roomId
    };
  }}
/>
```

ƒê·ªÉ tr√°nh l√†m cho n√≥ tr·ªü th√†nh dependency (v√† khi·∫øn n√≥ k·∫øt n·ªëi l·∫°i khi render l·∫°i), h√£y g·ªçi n√≥ b√™n ngo√†i Effect. ƒêi·ªÅu n√†y cung c·∫•p cho b·∫°n c√°c gi√° tr·ªã `roomId` v√† `serverUrl` kh√¥ng ph·∫£i l√† object, v√† b·∫°n c√≥ th·ªÉ ƒë·ªçc t·ª´ b√™n trong Effect:

```js {1,4}
function ChatRoom({ getOptions }) {
  const [message, setMessage] = useState('');

  const { roomId, serverUrl } = getOptions();
  useEffect(() => {
    const connection = createConnection({
      roomId: roomId,
      serverUrl: serverUrl
    });
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]); // ‚úÖ All dependencies declared
  // ...
```

ƒêi·ªÅu n√†y ch·ªâ ho·∫°t ƒë·ªông cho c√°c [function thu·∫ßn khi·∫øt](/learn/keeping-components-pure) v√¨ ch√∫ng an to√†n ƒë·ªÉ g·ªçi trong qu√° tr√¨nh rendering. N·∫øu function c·ªßa b·∫°n l√† m·ªôt event handler, nh∆∞ng b·∫°n kh√¥ng mu·ªën nh·ªØng thay ƒë·ªïi c·ªßa n√≥ ƒë·ªìng b·ªô l·∫°i Effect, [h√£y bao b·ªçc n√≥ v√†o m·ªôt Effect Event thay th·∫ø.](#do-you-want-to-read-a-value-without-reacting-to-its-changes)

<Recap>

- C√°c dependency n√™n lu√¥n kh·ªõp v·ªõi code.
- Khi b·∫°n kh√¥ng h√†i l√≤ng v·ªõi c√°c dependency, ƒëi·ªÅu b·∫°n c·∫ßn ch·ªânh s·ª≠a l√† code.
- Vi·ªác b·ªè qua linter d·∫´n ƒë·∫øn nh·ªØng bug r·∫•t kh√≥ hi·ªÉu, v√† b·∫°n n√™n lu√¥n tr√°nh ƒëi·ªÅu ƒë√≥.
- ƒê·ªÉ lo·∫°i b·ªè m·ªôt dependency, b·∫°n c·∫ßn "ch·ª©ng minh" cho linter r·∫±ng n√≥ kh√¥ng c·∫ßn thi·∫øt.
- N·∫øu m·ªôt s·ªë code n√™n ch·∫°y ƒë·ªÉ ph·∫£n h·ªìi m·ªôt t∆∞∆°ng t√°c c·ª• th·ªÉ, h√£y di chuy·ªÉn code ƒë√≥ v√†o m·ªôt event handler.
- N·∫øu c√°c ph·∫ßn kh√°c nhau c·ªßa Effect n√™n ch·∫°y l·∫°i v√¨ nh·ªØng l√Ω do kh√°c nhau, h√£y chia n√≥ th√†nh nhi·ªÅu Effect.
- N·∫øu b·∫°n mu·ªën c·∫≠p nh·∫≠t m·ªôt s·ªë state d·ª±a tr√™n state tr∆∞·ªõc ƒë√≥, h√£y truy·ªÅn m·ªôt updater function.
- N·∫øu b·∫°n mu·ªën ƒë·ªçc gi√° tr·ªã m·ªõi nh·∫•t m√† kh√¥ng "ph·∫£n ·ª©ng" v·ªõi n√≥, h√£y tr√≠ch xu·∫•t m·ªôt Effect Event t·ª´ Effect c·ªßa b·∫°n.
- Trong JavaScript, c√°c object v√† function ƒë∆∞·ª£c coi l√† kh√°c nhau n·∫øu ch√∫ng ƒë∆∞·ª£c t·∫°o ra ·ªü nh·ªØng th·ªùi ƒëi·ªÉm kh√°c nhau.
- H√£y c·ªë g·∫Øng tr√°nh c√°c dependency l√† object v√† function. Di chuy·ªÉn ch√∫ng ra ngo√†i component ho·∫∑c v√†o trong Effect.

</Recap>

<Challenges>

#### S·ª≠a interval b·ªã reset {/*fix-a-resetting-interval*/}

Effect n√†y thi·∫øt l·∫≠p m·ªôt interval tick m·ªói gi√¢y. B·∫°n nh·∫≠n th·∫•y c√≥ ƒëi·ªÅu g√¨ ƒë√≥ l·∫° x·∫£y ra: c√≥ v·∫ª nh∆∞ interval b·ªã h·ªßy v√† t·∫°o l·∫°i m·ªói khi n√≥ tick. H√£y s·ª≠a code ƒë·ªÉ interval kh√¥ng b·ªã t·∫°o l·∫°i li√™n t·ª•c.

<Hint>

C√≥ v·∫ª nh∆∞ code Effect n√†y ph·ª• thu·ªôc v√†o `count`. C√≥ c√°ch n√†o ƒë·ªÉ kh√¥ng c·∫ßn dependency n√†y kh√¥ng? N√™n c√≥ c√°ch ƒë·ªÉ c·∫≠p nh·∫≠t state `count` d·ª±a tr√™n gi√° tr·ªã tr∆∞·ªõc ƒë√≥ m√† kh√¥ng c·∫ßn th√™m dependency v√†o gi√° tr·ªã ƒë√≥.

</Hint>

<Sandpack>

```js
import { useState, useEffect } from 'react';

export default function Timer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log('‚úÖ Creating an interval');
    const id = setInterval(() => {
      console.log('‚è∞ Interval tick');
      setCount(count + 1);
    }, 1000);
    return () => {
      console.log('‚ùå Clearing an interval');
      clearInterval(id);
    };
  }, [count]);

  return <h1>Counter: {count}</h1>
}
```

</Sandpack>

<Solution>

B·∫°n mu·ªën c·∫≠p nh·∫≠t state `count` th√†nh `count + 1` t·ª´ b√™n trong Effect. Tuy nhi√™n, ƒëi·ªÅu n√†y khi·∫øn Effect c·ªßa b·∫°n ph·ª• thu·ªôc v√†o `count`, thay ƒë·ªïi v·ªõi m·ªói tick, v√† ƒë√≥ l√† l√Ω do t·∫°i sao interval c·ªßa b·∫°n b·ªã t·∫°o l·∫°i ·ªü m·ªói tick.

ƒê·ªÉ gi·∫£i quy·∫øt ƒëi·ªÅu n√†y, h√£y s·ª≠ d·ª•ng [updater function](/reference/react/useState#updating-state-based-on-the-previous-state) v√† vi·∫øt `setCount(c => c + 1)` thay v√¨ `setCount(count + 1)`:

<Sandpack>

```js
import { useState, useEffect } from 'react';

export default function Timer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log('‚úÖ Creating an interval');
    const id = setInterval(() => {
      console.log('‚è∞ Interval tick');
      setCount(c => c + 1);
    }, 1000);
    return () => {
      console.log('‚ùå Clearing an interval');
      clearInterval(id);
    };
  }, []);

  return <h1>Counter: {count}</h1>
}
```

</Sandpack>

Thay v√¨ ƒë·ªçc `count` b√™n trong Effect, b·∫°n truy·ªÅn m·ªôt ch·ªâ th·ªã `c => c + 1` ("tƒÉng s·ªë n√†y l√™n!") cho React. React s·∫Ω √°p d·ª•ng n√≥ trong l·∫ßn render ti·∫øp theo. V√† v√¨ b·∫°n kh√¥ng c·∫ßn ƒë·ªçc gi√° tr·ªã c·ªßa `count` b√™n trong Effect n·ªØa, b·∫°n c√≥ th·ªÉ gi·ªØ cho c√°c dependency c·ªßa Effect tr·ªëng (`[]`). ƒêi·ªÅu n√†y ngƒÉn Effect c·ªßa b·∫°n t·∫°o l·∫°i interval ·ªü m·ªói tick.

</Solution>

#### S·ª≠a animation b·ªã k√≠ch ho·∫°t l·∫°i {/*fix-a-retriggering-animation*/}

Trong v√≠ d·ª• n√†y, khi b·∫°n nh·∫•n "Show", m·ªôt th√¥ng b√°o ch√†o m·ª´ng s·∫Ω fade in. Animation m·∫•t m·ªôt gi√¢y. Khi b·∫°n nh·∫•n "Remove", th√¥ng b√°o ch√†o m·ª´ng bi·∫øn m·∫•t ngay l·∫≠p t·ª©c. Logic cho animation fade-in ƒë∆∞·ª£c tri·ªÉn khai trong file `animation.js` nh∆∞ m·ªôt [animation loop](https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame) JavaScript thu·∫ßn. B·∫°n kh√¥ng c·∫ßn thay ƒë·ªïi logic ƒë√≥. B·∫°n c√≥ th·ªÉ coi n√≥ nh∆∞ m·ªôt th∆∞ vi·ªán b√™n th·ª© ba. Effect c·ªßa b·∫°n t·∫°o m·ªôt instance c·ªßa `FadeInAnimation` cho DOM node, v√† sau ƒë√≥ g·ªçi `start(duration)` ho·∫∑c `stop()` ƒë·ªÉ ƒëi·ªÅu khi·ªÉn animation. `duration` ƒë∆∞·ª£c ƒëi·ªÅu khi·ªÉn b·∫±ng m·ªôt slider. ƒêi·ªÅu ch·ªânh slider v√† xem animation thay ƒë·ªïi nh∆∞ th·∫ø n√†o.

Code n√†y ƒë√£ ho·∫°t ƒë·ªông, nh∆∞ng c√≥ ƒëi·ªÅu g√¨ ƒë√≥ b·∫°n mu·ªën thay ƒë·ªïi. Hi·ªán t·∫°i, khi b·∫°n di chuy·ªÉn slider ƒëi·ªÅu khi·ªÉn bi·∫øn state `duration`, n√≥ k√≠ch ho·∫°t l·∫°i animation. Thay ƒë·ªïi h√†nh vi ƒë·ªÉ Effect kh√¥ng "ph·∫£n ·ª©ng" v·ªõi bi·∫øn `duration`. Khi b·∫°n nh·∫•n "Show", Effect n√™n s·ª≠ d·ª•ng `duration` hi·ªán t·∫°i tr√™n slider. Tuy nhi√™n, vi·ªác di chuy·ªÉn slider b·∫£n th√¢n n√≥ kh√¥ng n√™n k√≠ch ho·∫°t l·∫°i animation.

<Hint>

C√≥ m·ªôt d√≤ng code b√™n trong Effect kh√¥ng n√™n l√† reactive kh√¥ng? L√†m th·∫ø n√†o b·∫°n c√≥ th·ªÉ di chuy·ªÉn code kh√¥ng reactive ra kh·ªèi Effect?

</Hint>

<Sandpack>

```json package.json hidden
{
  "dependencies": {
    "react": "experimental",
    "react-dom": "experimental",
    "react-scripts": "latest"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test --env=jsdom",
    "eject": "react-scripts eject"
  }
}
```

```js
import { useState, useEffect, useRef } from 'react';
import { experimental_useEffectEvent as useEffectEvent } from 'react';
import { FadeInAnimation } from './animation.js';

function Welcome({ duration }) {
  const ref = useRef(null);

  useEffect(() => {
    const animation = new FadeInAnimation(ref.current);
    animation.start(duration);
    return () => {
      animation.stop();
    };
  }, [duration]);

  return (
    <h1
      ref={ref}
      style={{
        opacity: 0,
        color: 'white',
        padding: 50,
        textAlign: 'center',
        fontSize: 50,
        backgroundImage: 'radial-gradient(circle, rgba(63,94,251,1) 0%, rgba(252,70,107,1) 100%)'
      }}
    >
      Welcome
    </h1>
  );
}

export default function App() {
  const [duration, setDuration] = useState(1000);
  const [show, setShow] = useState(false);

  return (
    <>
      <label>
        <input
          type="range"
          min="100"
          max="3000"
          value={duration}
          onChange={e => setDuration(Number(e.target.value))}
        />
        <br />
        Fade in duration: {duration} ms
      </label>
      <button onClick={() => setShow(!show)}>
        {show ? 'Remove' : 'Show'}
      </button>
      <hr />
      {show && <Welcome duration={duration} />}
    </>
  );
}
```

```js src/animation.js
export class FadeInAnimation {
  constructor(node) {
    this.node = node;
  }
  start(duration) {
    this.duration = duration;
    if (this.duration === 0) {
      // Jump to end immediately
      this.onProgress(1);
    } else {
      this.onProgress(0);
      // Start animating
      this.startTime = performance.now();
      this.frameId = requestAnimationFrame(() => this.onFrame());
    }
  }
  onFrame() {
    const timePassed = performance.now() - this.startTime;
    const progress = Math.min(timePassed / this.duration, 1);
    this.onProgress(progress);
    if (progress < 1) {
      // We still have more frames to paint
      this.frameId = requestAnimationFrame(() => this.onFrame());
    }
  }
  onProgress(progress) {
    this.node.style.opacity = progress;
  }
  stop() {
    cancelAnimationFrame(this.frameId);
    this.startTime = null;
    this.frameId = null;
    this.duration = 0;
  }
}
```

```css
label, button { display: block; margin-bottom: 20px; }
html, body { min-height: 300px; }
```

</Sandpack>

<Solution>

Effect c·ªßa b·∫°n c·∫ßn ƒë·ªçc gi√° tr·ªã m·ªõi nh·∫•t c·ªßa `duration`, nh∆∞ng b·∫°n kh√¥ng mu·ªën n√≥ "ph·∫£n ·ª©ng" v·ªõi nh·ªØng thay ƒë·ªïi trong `duration`. B·∫°n s·ª≠ d·ª•ng `duration` ƒë·ªÉ b·∫Øt ƒë·∫ßu animation, nh∆∞ng vi·ªác b·∫Øt ƒë·∫ßu animation kh√¥ng ph·∫£i l√† reactive. Tr√≠ch xu·∫•t d√≤ng code kh√¥ng reactive v√†o m·ªôt Effect Event, v√† g·ªçi function ƒë√≥ t·ª´ Effect c·ªßa b·∫°n.

<Sandpack>

```json package.json hidden
{
  "dependencies": {
    "react": "experimental",
    "react-dom": "experimental",
    "react-scripts": "latest"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test --env=jsdom",
    "eject": "react-scripts eject"
  }
}
```

```js
import { useState, useEffect, useRef } from 'react';
import { FadeInAnimation } from './animation.js';
import { experimental_useEffectEvent as useEffectEvent } from 'react';

function Welcome({ duration }) {
  const ref = useRef(null);

  const onAppear = useEffectEvent(animation => {
    animation.start(duration);
  });

  useEffect(() => {
    const animation = new FadeInAnimation(ref.current);
    onAppear(animation);
    return () => {
      animation.stop();
    };
  }, []);

  return (
    <h1
      ref={ref}
      style={{
        opacity: 0,
        color: 'white',
        padding: 50,
        textAlign: 'center',
        fontSize: 50,
        backgroundImage: 'radial-gradient(circle, rgba(63,94,251,1) 0%, rgba(252,70,107,1) 100%)'
      }}
    >
      Welcome
    </h1>
  );
}

export default function App() {
  const [duration, setDuration] = useState(1000);
  const [show, setShow] = useState(false);

  return (
    <>
      <label>
        <input
          type="range"
          min="100"
          max="3000"
          value={duration}
          onChange={e => setDuration(Number(e.target.value))}
        />
        <br />
        Fade in duration: {duration} ms
      </label>
      <button onClick={() => setShow(!show)}>
        {show ? 'Remove' : 'Show'}
      </button>
      <hr />
      {show && <Welcome duration={duration} />}
    </>
  );
}
```

```js src/animation.js
export class FadeInAnimation {
  constructor(node) {
    this.node = node;
  }
  start(duration) {
    this.duration = duration;
    this.onProgress(0);
    this.startTime = performance.now();
    this.frameId = requestAnimationFrame(() => this.onFrame());
  }
  onFrame() {
    const timePassed = performance.now() - this.startTime;
    const progress = Math.min(timePassed / this.duration, 1);
    this.onProgress(progress);
    if (progress < 1) {
      // We still have more frames to paint
      this.frameId = requestAnimationFrame(() => this.onFrame());
    }
  }
  onProgress(progress) {
    this.node.style.opacity = progress;
  }
  stop() {
    cancelAnimationFrame(this.frameId);
    this.startTime = null;
    this.frameId = null;
    this.duration = 0;
  }
}
```

```css
label, button { display: block; margin-bottom: 20px; }
html, body { min-height: 300px; }
```

</Sandpack>

Effect Event nh∆∞ `onAppear` kh√¥ng ph·∫£i l√† reactive, v√¨ v·∫≠y b·∫°n c√≥ th·ªÉ ƒë·ªçc `duration` b√™n trong m√† kh√¥ng k√≠ch ho·∫°t l·∫°i animation.

</Solution>

#### S·ª≠a chat b·ªã k·∫øt n·ªëi l·∫°i {/*fix-a-reconnecting-chat*/}

Trong v√≠ d·ª• n√†y, m·ªói khi b·∫°n nh·∫•n "Toggle theme", chat s·∫Ω k·∫øt n·ªëi l·∫°i. T·∫°i sao ƒëi·ªÅu n√†y x·∫£y ra? H√£y s·ª≠a l·ªói ƒë·ªÉ chat ch·ªâ k·∫øt n·ªëi l·∫°i khi b·∫°n ch·ªânh s·ª≠a Server URL ho·∫∑c ch·ªçn m·ªôt ph√≤ng chat kh√°c.

Coi `chat.js` nh∆∞ m·ªôt th∆∞ vi·ªán b√™n th·ª© ba: b·∫°n c√≥ th·ªÉ tham kh·∫£o n√≥ ƒë·ªÉ ki·ªÉm tra API, nh∆∞ng ƒë·ª´ng ch·ªânh s·ª≠a n√≥.

<Hint>

C√≥ nhi·ªÅu c√°ch ƒë·ªÉ s·ª≠a ƒëi·ªÅu n√†y, nh∆∞ng cu·ªëi c√πng b·∫°n mu·ªën tr√°nh c√≥ m·ªôt object l√†m dependency c·ªßa m√¨nh.

</Hint>

<Sandpack>

```js src/App.js
import { useState } from 'react';
import ChatRoom from './ChatRoom.js';

export default function App() {
  const [isDark, setIsDark] = useState(false);
  const [roomId, setRoomId] = useState('general');
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  const options = {
    serverUrl: serverUrl,
    roomId: roomId
  };

  return (
    <div className={isDark ? 'dark' : 'light'}>
      <button onClick={() => setIsDark(!isDark)}>
        Toggle theme
      </button>
      <label>
        Server URL:{' '}
        <input
          value={serverUrl}
          onChange={e => setServerUrl(e.target.value)}
        />
      </label>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom options={options} />
    </div>
  );
}
```

```js src/ChatRoom.js active
import { useEffect } from 'react';
import { createConnection } from './chat.js';

export default function ChatRoom({ options }) {
  useEffect(() => {
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [options]);

  return <h1>Welcome to the {options.roomId} room!</h1>;
}
```

```js src/chat.js
export function createConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  if (typeof serverUrl !== 'string') {
    throw Error('Expected serverUrl to be a string. Received: ' + serverUrl);
  }
  if (typeof roomId !== 'string') {
    throw Error('Expected roomId to be a string. Received: ' + roomId);
  }
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
label, button { display: block; margin-bottom: 5px; }
.dark { background: #222; color: #eee; }
```

</Sandpack>

<Solution>

Effect c·ªßa b·∫°n ƒëang ch·∫°y l·∫°i v√¨ n√≥ ph·ª• thu·ªôc v√†o object `options`. C√°c object c√≥ th·ªÉ ƒë∆∞·ª£c t·∫°o l·∫°i m·ªôt c√°ch kh√¥ng c·ªë √Ω, b·∫°n n√™n c·ªë g·∫Øng tr√°nh ch√∫ng l√†m dependency c·ªßa Effect b·∫•t c·ª© khi n√†o c√≥ th·ªÉ.

C√°ch s·ª≠a √≠t x√¢m l·∫•n nh·∫•t l√† ƒë·ªçc `roomId` v√† `serverUrl` ngay b√™n ngo√†i Effect, v√† sau ƒë√≥ l√†m cho Effect ph·ª• thu·ªôc v√†o nh·ªØng gi√° tr·ªã nguy√™n th·ªßy ƒë√≥ (kh√¥ng th·ªÉ thay ƒë·ªïi m·ªôt c√°ch kh√¥ng c·ªë √Ω). B√™n trong Effect, t·∫°o m·ªôt object v√† truy·ªÅn n√≥ cho `createConnection`:

<Sandpack>

```js src/App.js
import { useState } from 'react';
import ChatRoom from './ChatRoom.js';

export default function App() {
  const [isDark, setIsDark] = useState(false);
  const [roomId, setRoomId] = useState('general');
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  const options = {
    serverUrl: serverUrl,
    roomId: roomId
  };

  return (
    <div className={isDark ? 'dark' : 'light'}>
      <button onClick={() => setIsDark(!isDark)}>
        Toggle theme
      </button>
      <label>
        Server URL:{' '}
        <input
          value={serverUrl}
          onChange={e => setServerUrl(e.target.value)}
        />
      </label>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom options={options} />
    </div>
  );
}
```

```js src/ChatRoom.js active
import { useEffect } from 'react';
import { createConnection } from './chat.js';

export default function ChatRoom({ options }) {
  const { roomId, serverUrl } = options;
  useEffect(() => {
    const connection = createConnection({
      roomId: roomId,
      serverUrl: serverUrl
    });
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]);

  return <h1>Welcome to the {options.roomId} room!</h1>;
}
```

```js src/chat.js
export function createConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  if (typeof serverUrl !== 'string') {
    throw Error('Expected serverUrl to be a string. Received: ' + serverUrl);
  }
  if (typeof roomId !== 'string') {
    throw Error('Expected roomId to be a string. Received: ' + roomId);
  }
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
label, button { display: block; margin-bottom: 5px; }
.dark { background: #222; color: #eee; }
```

</Sandpack>

S·∫Ω t·ªët h∆°n n·ªØa n·∫øu thay th·∫ø prop object `options` b·∫±ng c√°c prop c·ª• th·ªÉ h∆°n l√† `roomId` v√† `serverUrl`:

<Sandpack>

```js src/App.js
import { useState } from 'react';
import ChatRoom from './ChatRoom.js';

export default function App() {
  const [isDark, setIsDark] = useState(false);
  const [roomId, setRoomId] = useState('general');
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  return (
    <div className={isDark ? 'dark' : 'light'}>
      <button onClick={() => setIsDark(!isDark)}>
        Toggle theme
      </button>
      <label>
        Server URL:{' '}
        <input
          value={serverUrl}
          onChange={e => setServerUrl(e.target.value)}
        />
      </label>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom
        roomId={roomId}
        serverUrl={serverUrl}
      />
    </div>
  );
}
```

```js src/ChatRoom.js active
import { useState, useEffect } from 'react';
import { createConnection } from './chat.js';

export default function ChatRoom({ roomId, serverUrl }) {
  useEffect(() => {
    const connection = createConnection({
      roomId: roomId,
      serverUrl: serverUrl
    });
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]);

  return <h1>Welcome to the {roomId} room!</h1>;
}
```

```js src/chat.js
export function createConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  if (typeof serverUrl !== 'string') {
    throw Error('Expected serverUrl to be a string. Received: ' + serverUrl);
  }
  if (typeof roomId !== 'string') {
    throw Error('Expected roomId to be a string. Received: ' + roomId);
  }
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room at ' + serverUrl + '...');
    },
    disconnect() {
      console.log('‚ùå Disconnected from "' + roomId + '" room at ' + serverUrl);
    }
  };
}
```

```css
label, button { display: block; margin-bottom: 5px; }
.dark { background: #222; color: #eee; }
```

</Sandpack>

Gi·ªØ c√°c prop nguy√™n th·ªßy b·∫•t c·ª© khi n√†o c√≥ th·ªÉ s·∫Ω gi√∫p vi·ªác t·ªëi ∆∞u h√≥a component c·ªßa b·∫°n d·ªÖ d√†ng h∆°n sau n√†y.

</Solution>

#### S·ª≠a chat b·ªã k·∫øt n·ªëi l·∫°i, l·∫ßn n·ªØa {/*fix-a-reconnecting-chat-again*/}

V√≠ d·ª• n√†y k·∫øt n·ªëi v·ªõi chat c√≥ ho·∫∑c kh√¥ng c√≥ m√£ h√≥a. B·∫≠t/t·∫Øt checkbox v√† ch√∫ √Ω c√°c th√¥ng b√°o kh√°c nhau trong console khi m√£ h√≥a ƒë∆∞·ª£c b·∫≠t v√† t·∫Øt. Th·ª≠ thay ƒë·ªïi ph√≤ng. Sau ƒë√≥, th·ª≠ b·∫≠t/t·∫Øt theme. Khi b·∫°n k·∫øt n·ªëi v·ªõi m·ªôt ph√≤ng chat, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn m·ªõi v√†i gi√¢y m·ªôt l·∫ßn. X√°c minh r·∫±ng m√†u c·ªßa ch√∫ng kh·ªõp v·ªõi theme b·∫°n ƒë√£ ch·ªçn.

Trong v√≠ d·ª• n√†y, chat k·∫øt n·ªëi l·∫°i m·ªói khi b·∫°n c·ªë g·∫Øng thay ƒë·ªïi theme. H√£y s·ª≠a ƒëi·ªÅu n√†y. Sau khi s·ª≠a, vi·ªác thay ƒë·ªïi theme kh√¥ng n√™n k·∫øt n·ªëi l·∫°i chat, nh∆∞ng vi·ªác b·∫≠t/t·∫Øt c√†i ƒë·∫∑t m√£ h√≥a ho·∫∑c thay ƒë·ªïi ph√≤ng th√¨ n√™n k·∫øt n·ªëi l·∫°i.

ƒê·ª´ng thay ƒë·ªïi b·∫•t k·ª≥ code n√†o trong `chat.js`. Ngo√†i ra, b·∫°n c√≥ th·ªÉ thay ƒë·ªïi b·∫•t k·ª≥ code n√†o mi·ªÖn l√† n√≥ t·∫°o ra c√πng m·ªôt h√†nh vi. V√≠ d·ª•, b·∫°n c√≥ th·ªÉ th·∫•y h·ªØu √≠ch khi thay ƒë·ªïi props n√†o ƒë∆∞·ª£c truy·ªÅn xu·ªëng.

<Hint>

B·∫°n ƒëang truy·ªÅn xu·ªëng hai function: `onMessage` v√† `createConnection`. C·∫£ hai ƒë·ªÅu ƒë∆∞·ª£c t·∫°o t·ª´ ƒë·∫ßu m·ªói khi `App` render l·∫°i. Ch√∫ng ƒë∆∞·ª£c coi l√† c√°c gi√° tr·ªã m·ªõi m·ªói l·∫ßn, ƒë√≥ l√† l√Ω do t·∫°i sao ch√∫ng k√≠ch ho·∫°t l·∫°i Effect c·ªßa b·∫°n.

M·ªôt trong nh·ªØng function n√†y l√† event handler. B·∫°n c√≥ bi·∫øt c√°ch n√†o ƒë·ªÉ g·ªçi m·ªôt event handler trong Effect m√† kh√¥ng "ph·∫£n ·ª©ng" v·ªõi c√°c gi√° tr·ªã m·ªõi c·ªßa function event handler kh√¥ng? ƒêi·ªÅu ƒë√≥ s·∫Ω r·∫•t h·ªØu √≠ch!

M·ªôt function kh√°c ch·ªâ t·ªìn t·∫°i ƒë·ªÉ truy·ªÅn m·ªôt s·ªë state cho m·ªôt ph∆∞∆°ng th·ª©c API ƒë√£ import. Function n√†y c√≥ th·ª±c s·ª± c·∫ßn thi·∫øt kh√¥ng? Th√¥ng tin quan tr·ªçng n√†o ƒëang ƒë∆∞·ª£c truy·ªÅn xu·ªëng? B·∫°n c√≥ th·ªÉ c·∫ßn di chuy·ªÉn m·ªôt s·ªë import t·ª´ `App.js` sang `ChatRoom.js`.

</Hint>

<Sandpack>

```json package.json hidden
{
  "dependencies": {
    "react": "experimental",
    "react-dom": "experimental",
    "react-scripts": "latest",
    "toastify-js": "1.12.0"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test --env=jsdom",
    "eject": "react-scripts eject"
  }
}
```

```js src/App.js
import { useState } from 'react';
import ChatRoom from './ChatRoom.js';
import {
  createEncryptedConnection,
  createUnencryptedConnection,
} from './chat.js';
import { showNotification } from './notifications.js';

export default function App() {
  const [isDark, setIsDark] = useState(false);
  const [roomId, setRoomId] = useState('general');
  const [isEncrypted, setIsEncrypted] = useState(false);

  return (
    <>
      <label>
        <input
          type="checkbox"
          checked={isDark}
          onChange={e => setIsDark(e.target.checked)}
        />
        Use dark theme
      </label>
      <label>
        <input
          type="checkbox"
          checked={isEncrypted}
          onChange={e => setIsEncrypted(e.target.checked)}
        />
        Enable encryption
      </label>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom
        roomId={roomId}
        onMessage={msg => {
          showNotification('New message: ' + msg, isDark ? 'dark' : 'light');
        }}
        createConnection={() => {
          const options = {
            serverUrl: 'https://localhost:1234',
            roomId: roomId
          };
          if (isEncrypted) {
            return createEncryptedConnection(options);
          } else {
            return createUnencryptedConnection(options);
          }
        }}
      />
    </>
  );
}
```

```js src/ChatRoom.js active
import { useState, useEffect } from 'react';
import { experimental_useEffectEvent as useEffectEvent } from 'react';

export default function ChatRoom({ roomId, createConnection, onMessage }) {
  useEffect(() => {
    const connection = createConnection();
    connection.on('message', (msg) => onMessage(msg));
    connection.connect();
    return () => connection.disconnect();
  }, [createConnection, onMessage]);

  return <h1>Welcome to the {roomId} room!</h1>;
}
```

```js src/chat.js
export function createEncryptedConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  if (typeof serverUrl !== 'string') {
    throw Error('Expected serverUrl to be a string. Received: ' + serverUrl);
  }
  if (typeof roomId !== 'string') {
    throw Error('Expected roomId to be a string. Received: ' + roomId);
  }
  let intervalId;
  let messageCallback;
  return {
    connect() {
      console.log('‚úÖ üîê Connecting to "' + roomId + '" room... (encrypted)');
      clearInterval(intervalId);
      intervalId = setInterval(() => {
        if (messageCallback) {
          if (Math.random() > 0.5) {
            messageCallback('hey')
          } else {
            messageCallback('lol');
          }
        }
      }, 3000);
    },
    disconnect() {
      clearInterval(intervalId);
      messageCallback = null;
      console.log('‚ùå üîê Disconnected from "' + roomId + '" room (encrypted)');
    },
    on(event, callback) {
      if (messageCallback) {
        throw Error('Cannot add the handler twice.');
      }
      if (event !== 'message') {
        throw Error('Only "message" event is supported.');
      }
      messageCallback = callback;
    },
  };
}

export function createUnencryptedConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  if (typeof serverUrl !== 'string') {
    throw Error('Expected serverUrl to be a string. Received: ' + serverUrl);
  }
  if (typeof roomId !== 'string') {
    throw Error('Expected roomId to be a string. Received: ' + roomId);
  }
  let intervalId;
  let messageCallback;
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room (unencrypted)...');
      clearInterval(intervalId);
      intervalId = setInterval(() => {
        if (messageCallback) {
          if (Math.random() > 0.5) {
            messageCallback('hey')
          } else {
            messageCallback('lol');
          }
        }
      }, 3000);
    },
    disconnect() {
      clearInterval(intervalId);
      messageCallback = null;
      console.log('‚ùå Disconnected from "' + roomId + '" room (unencrypted)');
    },
    on(event, callback) {
      if (messageCallback) {
        throw Error('Cannot add the handler twice.');
      }
      if (event !== 'message') {
        throw Error('Only "message" event is supported.');
      }
      messageCallback = callback;
    },
  };
}
```

```js src/notifications.js
import Toastify from 'toastify-js';
import 'toastify-js/src/toastify.css';

export function showNotification(message, theme) {
  Toastify({
    text: message,
    duration: 2000,
    gravity: 'top',
    position: 'right',
    style: {
      background: theme === 'dark' ? 'black' : 'white',
      color: theme === 'dark' ? 'white' : 'black',
    },
  }).showToast();
}
```

```css
label, button { display: block; margin-bottom: 5px; }
```

</Sandpack>

<Solution>

C√≥ nhi·ªÅu c√°ch ƒë√∫ng ƒë·ªÉ gi·∫£i quy·∫øt ƒëi·ªÅu n√†y, nh∆∞ng ƒë√¢y l√† m·ªôt gi·∫£i ph√°p c√≥ th·ªÉ.

Trong v√≠ d·ª• ban ƒë·∫ßu, vi·ªác b·∫≠t/t·∫Øt theme khi·∫øn c√°c function `onMessage` v√† `createConnection` kh√°c nhau ƒë∆∞·ª£c t·∫°o v√† truy·ªÅn xu·ªëng. V√¨ Effect ph·ª• thu·ªôc v√†o nh·ªØng function n√†y, chat s·∫Ω k·∫øt n·ªëi l·∫°i m·ªói khi b·∫°n b·∫≠t/t·∫Øt theme.

ƒê·ªÉ s·ª≠a v·∫•n ƒë·ªÅ v·ªõi `onMessage`, b·∫°n c·∫ßn bao b·ªçc n√≥ v√†o m·ªôt Effect Event:

```js {1,2,6}
export default function ChatRoom({ roomId, createConnection, onMessage }) {
  const onReceiveMessage = useEffectEvent(onMessage);

  useEffect(() => {
    const connection = createConnection();
    connection.on('message', (msg) => onReceiveMessage(msg));
    // ...
```

Kh√¥ng gi·ªëng nh∆∞ prop `onMessage`, Effect Event `onReceiveMessage` kh√¥ng ph·∫£i l√† reactive. ƒê√≥ l√† l√Ω do t·∫°i sao n√≥ kh√¥ng c·∫ßn ph·∫£i l√† dependency c·ªßa Effect. K·∫øt qu·∫£ l√†, nh·ªØng thay ƒë·ªïi trong `onMessage` s·∫Ω kh√¥ng khi·∫øn chat k·∫øt n·ªëi l·∫°i.

B·∫°n kh√¥ng th·ªÉ l√†m ƒëi·ªÅu t∆∞∆°ng t·ª± v·ªõi `createConnection` v√¨ n√≥ *n√™n* l√† reactive. B·∫°n *mu·ªën* Effect k√≠ch ho·∫°t l·∫°i n·∫øu ng∆∞·ªùi d√πng chuy·ªÉn ƒë·ªïi gi·ªØa k·∫øt n·ªëi m√£ h√≥a v√† kh√¥ng m√£ h√≥a, ho·∫∑c n·∫øu ng∆∞·ªùi d√πng chuy·ªÉn ƒë·ªïi ph√≤ng hi·ªán t·∫°i. Tuy nhi√™n, v√¨ `createConnection` l√† m·ªôt function, b·∫°n kh√¥ng th·ªÉ ki·ªÉm tra li·ªáu th√¥ng tin m√† n√≥ ƒë·ªçc c√≥ *th·ª±c s·ª±* thay ƒë·ªïi hay kh√¥ng. ƒê·ªÉ gi·∫£i quy·∫øt ƒëi·ªÅu n√†y, thay v√¨ truy·ªÅn `createConnection` xu·ªëng t·ª´ component `App`, h√£y truy·ªÅn c√°c gi√° tr·ªã `roomId` v√† `isEncrypted` th√¥:

```js {2-3}
      <ChatRoom
        roomId={roomId}
        isEncrypted={isEncrypted}
        onMessage={msg => {
          showNotification('New message: ' + msg, isDark ? 'dark' : 'light');
        }}
      />
```

B√¢y gi·ªù b·∫°n c√≥ th·ªÉ di chuy·ªÉn function `createConnection` *v√†o trong* Effect thay v√¨ truy·ªÅn n√≥ xu·ªëng t·ª´ `App`:

```js {1-4,6,10-20}
import {
  createEncryptedConnection,
  createUnencryptedConnection,
} from './chat.js';

export default function ChatRoom({ roomId, isEncrypted, onMessage }) {
  const onReceiveMessage = useEffectEvent(onMessage);

  useEffect(() => {
    function createConnection() {
      const options = {
        serverUrl: 'https://localhost:1234',
        roomId: roomId
      };
      if (isEncrypted) {
        return createEncryptedConnection(options);
      } else {
        return createUnencryptedConnection(options);
      }
    }
    // ...
```

Sau hai thay ƒë·ªïi n√†y, Effect c·ªßa b·∫°n kh√¥ng c√≤n ph·ª• thu·ªôc v√†o b·∫•t k·ª≥ gi√° tr·ªã function n√†o:

```js {1,8,10,21}
export default function ChatRoom({ roomId, isEncrypted, onMessage }) { // Reactive values
  const onReceiveMessage = useEffectEvent(onMessage); // Not reactive

  useEffect(() => {
    function createConnection() {
      const options = {
        serverUrl: 'https://localhost:1234',
        roomId: roomId // Reading a reactive value
      };
      if (isEncrypted) { // Reading a reactive value
        return createEncryptedConnection(options);
      } else {
        return createUnencryptedConnection(options);
      }
    }

    const connection = createConnection();
    connection.on('message', (msg) => onReceiveMessage(msg));
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, isEncrypted]); // ‚úÖ All dependencies declared
```

K·∫øt qu·∫£ l√†, chat ch·ªâ k·∫øt n·ªëi l·∫°i khi c√≥ ƒëi·ªÅu g√¨ ƒë√≥ c√≥ √Ω nghƒ©a (`roomId` ho·∫∑c `isEncrypted`) thay ƒë·ªïi:

<Sandpack>

```json package.json hidden
{
  "dependencies": {
    "react": "experimental",
    "react-dom": "experimental",
    "react-scripts": "latest",
    "toastify-js": "1.12.0"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test --env=jsdom",
    "eject": "react-scripts eject"
  }
}
```

```js src/App.js
import { useState } from 'react';
import ChatRoom from './ChatRoom.js';

import { showNotification } from './notifications.js';

export default function App() {
  const [isDark, setIsDark] = useState(false);
  const [roomId, setRoomId] = useState('general');
  const [isEncrypted, setIsEncrypted] = useState(false);

  return (
    <>
      <label>
        <input
          type="checkbox"
          checked={isDark}
          onChange={e => setIsDark(e.target.checked)}
        />
        Use dark theme
      </label>
      <label>
        <input
          type="checkbox"
          checked={isEncrypted}
          onChange={e => setIsEncrypted(e.target.checked)}
        />
        Enable encryption
      </label>
      <label>
        Choose the chat room:{' '}
        <select
          value={roomId}
          onChange={e => setRoomId(e.target.value)}
        >
          <option value="general">general</option>
          <option value="travel">travel</option>
          <option value="music">music</option>
        </select>
      </label>
      <hr />
      <ChatRoom
        roomId={roomId}
        isEncrypted={isEncrypted}
        onMessage={msg => {
          showNotification('New message: ' + msg, isDark ? 'dark' : 'light');
        }}
      />
    </>
  );
}
```

```js src/ChatRoom.js active
import { useState, useEffect } from 'react';
import { experimental_useEffectEvent as useEffectEvent } from 'react';
import {
  createEncryptedConnection,
  createUnencryptedConnection,
} from './chat.js';

export default function ChatRoom({ roomId, isEncrypted, onMessage }) {
  const onReceiveMessage = useEffectEvent(onMessage);

  useEffect(() => {
    function createConnection() {
      const options = {
        serverUrl: 'https://localhost:1234',
        roomId: roomId
      };
      if (isEncrypted) {
        return createEncryptedConnection(options);
      } else {
        return createUnencryptedConnection(options);
      }
    }

    const connection = createConnection();
    connection.on('message', (msg) => onReceiveMessage(msg));
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, isEncrypted]);

  return <h1>Welcome to the {roomId} room!</h1>;
}
```

```js src/chat.js
export function createEncryptedConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  if (typeof serverUrl !== 'string') {
    throw Error('Expected serverUrl to be a string. Received: ' + serverUrl);
  }
  if (typeof roomId !== 'string') {
    throw Error('Expected roomId to be a string. Received: ' + roomId);
  }
  let intervalId;
  let messageCallback;
  return {
    connect() {
      console.log('‚úÖ üîê Connecting to "' + roomId + '" room... (encrypted)');
      clearInterval(intervalId);
      intervalId = setInterval(() => {
        if (messageCallback) {
          if (Math.random() > 0.5) {
            messageCallback('hey')
          } else {
            messageCallback('lol');
          }
        }
      }, 3000);
    },
    disconnect() {
      clearInterval(intervalId);
      messageCallback = null;
      console.log('‚ùå üîê Disconnected from "' + roomId + '" room (encrypted)');
    },
    on(event, callback) {
      if (messageCallback) {
        throw Error('Cannot add the handler twice.');
      }
      if (event !== 'message') {
        throw Error('Only "message" event is supported.');
      }
      messageCallback = callback;
    },
  };
}

export function createUnencryptedConnection({ serverUrl, roomId }) {
  // A real implementation would actually connect to the server
  if (typeof serverUrl !== 'string') {
    throw Error('Expected serverUrl to be a string. Received: ' + serverUrl);
  }
  if (typeof roomId !== 'string') {
    throw Error('Expected roomId to be a string. Received: ' + roomId);
  }
  let intervalId;
  let messageCallback;
  return {
    connect() {
      console.log('‚úÖ Connecting to "' + roomId + '" room (unencrypted)...');
      clearInterval(intervalId);
      intervalId = setInterval(() => {
        if (messageCallback) {
          if (Math.random() > 0.5) {
            messageCallback('hey')
          } else {
            messageCallback('lol');
          }
        }
      }, 3000);
    },
    disconnect() {
      clearInterval(intervalId);
      messageCallback = null;
      console.log('‚ùå Disconnected from "' + roomId + '" room (unencrypted)');
    },
    on(event, callback) {
      if (messageCallback) {
        throw Error('Cannot add the handler twice.');
      }
      if (event !== 'message') {
        throw Error('Only "message" event is supported.');
      }
      messageCallback = callback;
    },
  };
}
```

```js src/notifications.js
import Toastify from 'toastify-js';
import 'toastify-js/src/toastify.css';

export function showNotification(message, theme) {
  Toastify({
    text: message,
    duration: 2000,
    gravity: 'top',
    position: 'right',
    style: {
      background: theme === 'dark' ? 'black' : 'white',
      color: theme === 'dark' ? 'white' : 'black',
    },
  }).showToast();
}
```

```css
label, button { display: block; margin-bottom: 5px; }
```

</Sandpack>

</Solution>

</Challenges>
